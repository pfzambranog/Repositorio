1> 2> Use DB_Siccorp_DES
1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> 165> 166> 167> 168> 169> 170> 171> 172> 173> 174> 175> 176> 177> 178> 179> 180> 181> 182> 183> 184> 185> 186> 187> 188> 189> 190> 191> 192> 193> 194> 195> 196> 197> 198> 199> 200> 201> 202> 203> 204> 205> 206> 207> 208> 209> 210> 211> 212> 213> 214> 215> 216> 217> 218> 219> 220> 221> 222> 223> 224> 225> 226> 227> 228> 229> 230> 231> 232> 233> 234> 235> 236> 237> 238> 239> 240> 241> 242> 243> 244> 245> 246> 247> 248> 249> 250> 251> 252> 253> 254> 255> 256> 257> 258> 259> 260> 261> 262> 263> 264> 265> 266> 267> 268> 269> 270> 271> 272> 273> 274> 275> 276> 277> 278> 279> 280> 281> 282> 283> 284> 285> 286> 287> 288> 289> 290> 291> 292> 293> 294> 295> 296> 297> 298> 299> 300> 301> 302> 303> 304> 305> 306> 307> 308> 309> 310> 311> 312> 313> 314> 315> 316> 317> 318> 319> 320> 321> 322> 323> 324> 325> 326> 327> 328> 329> 330> 331> 332> 333> 334> 335> 336> 337> 338> 339> 340> 341> 342> 343> 344> 345> 346> 347> 348> 349> 350> 351> 352> 353> 354> 355> 356> 357> 358> 359> 360> 361> 362> 363> 364> 365> 366> 367> 368> 369> 370> 371> 372> 373> 374> 375> 376> 377> 378> 379> 380> 381> 382> 383> 384> 385> 386> 387> 388> 389> 390> 391> 392> 393> 394> 395> 396> 397> 398> 399> 400> 401> 402> 403> 404> 405> 406> 407> 408> 409> 410> 411> 412> 413> 414> 415> 416> 417> 418> 419> 420> 421> 422> 423> 424> 425> 426> 427> 428> 429> 430> 431> 432> 433> 434> 435> 436> 437> 438> 439> 440> 441> 442> 443> 444> 445> 446> 447> 448> 449> 450> 451> 452> 453> 454> 455> 456> 457> 458> 459> 460> 461> 462> 463> 464> 465> 466> 467> 468> 469> 470> 471> 472> 473> 474> 475> 476> 477> 478> 479> 480> 481> 482> 483> 484> 485> 486> 487> 488> 489> 490> 491> 492> 493> 494> 495> 496> 497> 498> 499> 500> 501> 502> 503> 504> 505> 506> 507> 508> 509> 510> 511> 512> 513> 514> 515> 516> 517> 518> 519> 520> 521> 522> 523> 524> 525> 526> 527> 528> 529> 530> 531> 532> 533> 534> 535> 536> 537> 538> 539> 540> 541> 542> 543> 544> 545> 546> 547> 548> 549> 550> 551> 552> 553> 554> 555> 556> 557> 558> 559> 560> 561> 562> 563> 564> 565> 566> 567> 568> 569> 570> 571> 572> 573> 574> 575> 576> 577> 578> 579> 580> 581> 582> 583> 584> 585> 586> 587> 588> 589> 590> 591> 592> 593> 594> 595> 596> 597> 598> 599> 600> 601> 602> 603> 604> 605> 606> 607> 608> 609> 610> 611> 612> 613> 614> 615> 616> 617> 618> 619> 620> 621> 622> 623> 624> 625> 626> 627> 628> 629> 630> 631> 632> 633> 634> 635> 636> 637> 638> 639> 640> 641> 642> 643> 644> 645> 646> 647> 648> 649> 650> 651> 652> 653> 654> 655> 656> 657> 658> 659> 660> 661> 662> 663> 664> 665> 666> 667> 668> 669> 670> 671> 672> 673> 674> 675> 676> 677> 678> 679> 680> 681> 682> 683> 684> 685> 686> 687> 688> 689> 690> 691> 692> 693> 694> 695> 696> 697> 698> 699> 700> 701> 702> 703> 704> 705> 706> 707> 708> 709> 710> 711> 712> 713> 714> 715> 716> 717> 718> 719> 720> 721> 722> 723> 724> 725> 726> 727> 728> 729> 730> 731> 732> 733> 734> 735> 736> 737> 738> 739> 740> 741> 742> 743> 744> 745> 746> 747> 748> 749> 750> 751> 752> 753> 754> 755> 756> 757> 758> 759> 760> 761> 762> 763> 764> 765> 766> 767> 768> 769> 770> 771> 772> 773> 774> 775> 776> 777> 778> 779> 780> 781> 782> 783> 784> 785> 786> 787> 788> 789> 790> 791> 792> 793> 794> 795> 796> 797> 798> 799> 800> 801> 802> 803> 804> 805> 806> 807> 808> 809> 810> 811> 812> 813> 814> 815> 816> 817> 818> 819> 820> 821> 822> 823> 824> 825> 826> 827> 828> 829> 830> 831> 832> 833> 834> 835> 836> 837> 838> 839> 840> 841> 842> 843> 844> 845> 846> 847> 848> 849> 850> 851> 852> 853> 854> 855> 856> 857> 858> 859> 860> 861> 862> 863> 864> 865> 866> 867> 868> 869> 870> 871> 872> 873> 874> 875> 876> 877> 878> 879> 880> 881> 882> 883> 884> 885> 886> 887> 888> 889> 890> 891> 892> 893> 894> 895> 896> 897> 898> 899> 900> 901> 902> 903> 904> 905> 906> 907> 908> 909> 910> 911> 912> 913> 914> 915> 916> 917> 918> 919> 920> 921> 922> 923> 924> 925> 926> 927> 928> 929> 930> 931> 932> 933> 934> 935> 936> 937> 938> 939> 940> 941> 942> 943> 944> 945> 946> 947> 948> 949> 950> 951> 952> 953> 954> 955> 956> 957> 958> 959> 960> 961> 962> 963> 964> 965> 966> 967> 968> 969> 970> 971> 972> 973> 974> 975> 976> 977> 978> 979> 980> 981> 982> 983> 984> 985> 986> 987> 988> 989> 990> 991> 992> 993> 994> 995> 996> 997> 998> 999> 1000> 1001> 1002> 1003> 1004> 1005> 1006> 1007> 1008> 1009> 1010> 1011> 1012> 1013> 1014> 1015> 1016> 1017> 1018> 1019> 1020> 1021> 1022> 1023> 1024> 1025> 1026> 1027> 1028> 1029> 1030> 1031> 1032> 1033> 1034> 1035> 1036> 1037> 1038> 1039> 1040> 1041> 1042> 1043> 1044> 1045> 1046> 1047> 1048> 1049> 1050> 1051> 1052> 1053> 1054> 1055> 1056> 1057> 1058> 1059> 1060> 1061> 1062> 1063> 1064> 1065> 1066> 1067> 1068> 1069> 1070> 1071> 1072> 1073> 1074> 1075> 1076> 1077> 1078> 1079> 1080> 1081> 1082> 1083> 1084> 1085> 1086> 1087> 1088> 1089> 1090> 1091> 1092> 1093> 1094> 1095> 1096> 1097> 1098> 1099> 1100> 1101> 1102> 1103> 1104> 1105> 1106> 1107> 1108> 1109> 1110> 1111> 1112> 1113> 

--NOTA: IMPORTANTE este SP no se puede compilar en QA, por lo que nunca se debe reemplazar de QA hacia Preproducción.

-- Modificaciones:
-- V.0.1 Zayra Martinez Candia 18/05/2021. Se agrega validación, para el ejercicio.
-- V.0.2 Zayra Martinez Candia 07/03/2022. se comenta temporalmente delete de tabla RelacionImp (Se quita el comentario)
-- V.0.3 Zayra Martinez Candia 15/03/2022. Se agrega validacion adicional para que las polizas no se dupliquen
-- V.0.4 Zayra Martinez Candia 12/07/2022. Se corrige filtros de update para actualizar campo [no_poliza_compensa] de SET_DALTON
-- V.0.5 Zayra Martinez Candia 12/10/2022. Se agrega una nuevo campo en tablas de relacion para poder rastrear mejor las polizas y se quita validacion que no permitia reprocesar polizas
-- V.0.6 Zayra Martinez Candia 15/02/2023. Se agrega filtro a la validación de duplicidad de movdia2022
-- V.0.7 Zayra Martinez Candia 15/02/2023. Se moddica validacion de duplicidad de movdia2022 y mes
-- V.0.8 Erik González   11/01/2024. Se actualiza SP para funcionar solo en el año que se especifica
-- V.0.9 Erik González   01/03/2024. Se actualiza SP. Se agrega transacción y ROLLBACK en caso de error. También se agrega la sentencia With(Nolock) para los selects

-- V.0.10 Pedro Zambrano 28/09/2024. Se realiza reingenieria a fin de que se adapte a la nueva BD
--                                   Se Actualiza el campo referencia a 20.

-- exec sp_ImportarPolizas 2024

Create or Alter Procedure dbo.sp_ImportarPolizas
  (@PnEjercicio   Smallint,
   @PnEstatus     Integer      = 0   Output,
   @PsMensaje     Varchar(250) = ' ' Output)
As

--INICIALIZA VARIABLES --
--Variables para el proceso del filtro de polizas.

Declare
   @w_Error               Integer,
   @w_Desc_Error          Varchar(250),
   @w_mensaje             Varchar(250),
   @w_Abono               Char(1),
   @w_Cargo               Char(1),
   @w_totalCargo          Decimal(18, 2),
   @w_totalAbono          Decimal(18, 2),
   @w_minId               Integer,
   @w_maxId               Integer,
   @w_Referencia          Varchar(10),
   @w_TipoPol             Varchar(3),
   @w_TipoPolPDI          Varchar(3),
   @w_TipoPolPEG          Varchar(3),
   @w_TipoPolPIN          Varchar(3),
   @w_Fecha_Mov           Date,
   @w_Mes_Mov             Nvarchar(3),
   @w_NewRef              Varchar(10),
   @w_Ejercicio           Integer,
   @w_ContPol             Nvarchar(50),
   @w_Contador            Integer,
   @w_MovDia              Sysname,
   @w_PolDia              Sysname,
   @w_ContNoPol           Integer,
   @wz_Ejercicio          Varchar(4),
   @w_registros           Integer,
   @w_secuencia           Integer,
   @w_contPDI             Integer,
   @w_contPEG             Integer,
   @w_contPIN             Integer,
   @w_ConsReferencia      Varchar(20),
   @w_consecutivo         Integer,
   @w_ConsReferenciaInt   Integer,
   @w_para392             Integer,
   @w_instalado           Integer,
--
   @w_linea               Integer,
   @w_operacion           Integer,
   @w_comilla             Char(1),
   @w_fechaIni            Date,
   @w_fechaFin            Date,
   @w_fechaAct            Datetime,
   @w_mes                 Tinyint,
--
   @w_idusuario           Varchar(  Max),
   @w_usuario             Nvarchar(  20),
   @w_sql                 NVarchar(1500),
   @w_param               NVarchar( 750),
   @w_registrosImp        Integer;

Begin
   Set Nocount       On
   Set Xact_Abort    On
   Set Ansi_Nulls    Off
   Set Ansi_Warnings On
   Set Ansi_Padding  On

-- Inicializamos Variables

   Select  @PnEstatus      = 0,
           @PsMensaje      = ' ',
           @w_operacion    = 9999,
           @w_Abono        = 'C',
           @w_Cargo        = 'D',
           @w_consecutivo  = 0,
           @w_minId        = 0,
           @w_comilla      = Char(39),
           @w_TipoPolPDI   = 'PDI',
           @w_TipoPolPEG   = 'PEG',
           @w_TipoPolPIN   = 'PIN',
           @w_fechaIni     = Convert(Date, '01/01/' + Cast(@PnEjercicio As Varchar), 103),
           @w_fechaFin     = Convert(Date, '31/12/' + Cast(@PnEjercicio As Varchar), 103),
           @w_fechaAct     = Getdate(),
           @w_MovDia       = 'MovimientosAnio',
           @w_PolDia       = 'polizaAnio',
           @w_para392      = dbo.Fn_BuscaResultadosParametros( 392, 'valor'),
           @w_instalado    = dbo.Fn_BuscaResultadosParametros( 393, 'valor');

--
-- Búqueda de Parametros
--

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 9;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Set Xact_Abort    Off
         Return
      End

   If Not Exists ( Select Top 1 1 
                   From    dbo.PolDia P With(Nolock)
                   Where   p.Fecha_mov Between @w_fechaIni And @w_fechaFin
                   And     p.ejercicio       = @PnEjercicio)
      Begin
         Select @PnEstatus = 8172,
                @PsMensaje = dbo.Fn_Busca_MensajeError(@w_operacion, @PnEstatus)


         Set Xact_Abort    Off
         Return
      End
      
   Select @w_secuencia = Max($Identity)
   From   dbo.RelacionImp a With(Nolock)
   Set @w_secuencia = Isnull(@w_secuencia, 0)

--
-- Creación de Tablas Temporales
--

-- Crear tabla temporal para obtener cargos y abonos

   Create Table #tmpDiferencia
  (Consecutivo         Integer        Not Null Identity (1, 1) Primary Key,
   ejercicio           Integer        Not Null,
   mes                 Integer        Not Null,
   Referencia          Varchar(20)    Not Null,
   Fecha_Mov           Datetime       Not Null,
   Cargo               Decimal(18, 2) Not Null,
   Abono               Decimal(18, 2) Not Null,
   Diferencia          Decimal(18, 2) Not Null Default 0,
   Index tmpDiferenciaIdx01 Unique (ejercicio, mes, Referencia, Fecha_Mov));


-- Crear tabla TmpPoliza

   Create Table #tmpPoliza
  (Id                  Integer Identity(1,1) Not Null Primary key,
   Referencia          Varchar(20),
   NewReferencia       Varchar(20),
   Fecha_mov           Date,
   Fecha_Cap           Date,
   Concepto            Varchar(255),
   Cargos              Decimal(18, 2),
   Abonos              Decimal(18, 2),
   TCons               Integer,
   Usuario             Varchar(10),
   TipoPoliza          Varchar(3),
   Documento           Varchar(255),
   Usuario_cancela     Varchar(10),
   Fecha_cancela       Datetime,
   Status              smallint,
   Mes_Mov             Varchar(3),
   Ejercicio           Smallint,
   mes                 Tinyint,
   TipoPolizaConta     Varchar(3),
   FuenteDatos         Varchar(250),
   Index tmptmpPolizaIdx01 Unique (ejercicio, mes, Referencia, Fecha_Mov))

--Crear tabla tmpMovientos

   Create Table #tmpMovimientos
  (Id                  Integer        Not Null Identity(1,1)  Primary key,
   Referencia          Varchar( 20)   Not Null,
   NewReferencia       Varchar( 20)   Not Null Default Char(32),
   Cons                Integer,
   Moneda              Varchar(  2)   Not Null Default '00',
   Fecha_mov           Date           Not Null Default Getdate(),
   Llave               Varchar( 16),
   Concepto            Varchar(255),
   Importe             Decimal(18, 2) Not Null,
   Documento           Varchar(255),
   Clave               Char(1),
   FecCap              Date,
   Sector_id           Varchar(  2),
   Sucursal_id         Integer,
   Region_id           Integer,
   Importe_Cargo       Decimal(18, 2) Not Null Default 0.00,
   Importe_Abono       Decimal(18, 2) Not Null Default 0.00,
   Descrip             Varchar(150),
   TipoPolizaConta     Varchar(  3),
   ReferenciaFiscal    Varchar( 50),
   Fecha_Doc           Date,
   ejercicio           Smallint       Not Null,
   mes                 Tinyint        Not Null,
   Index tmpMovimientosIdx01 (ejercicio, mes, referencia, fecha_mov, Llave) )

  --Crear tabla temporal para obtener cargos y abonos

   Create Table #tmpCarAbo
  (Moneda              Varchar(2),
   totCar              Decimal(18, 2),
   totAbo              Decimal(18, 2))

--
-- Se incializa la tabla de log de errores
--

   Set @w_sql = 'Truncate Table logImportarPolErrorTbl'

   Begin Try
      Execute (@w_sql)
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If Isnull(@w_error, 0) != 0
      Begin
         Select @w_error, @w_desc_error;

         Set Xact_Abort    Off
         Return
      End

--
-- Inicio proceso de validación.
--

   Begin Transaction

  -- 1. Validar polizas que no tienen cuenta contable llamado Llave

      Select @w_mensaje = 'No existe cuenta contable ';

      Begin Try
         Insert Into dbo.logImportarPolErrorTbl
        (Referencia, Fecha_mov,  Llave, mensajeError)
         Select Referencia, Fecha_Mov, '',  @w_mensaje
         From   dbo.MovDia With(Nolock)
         Where  fecha_mov   Between @w_fechaIni And @w_fechaFin
         And    ejercicio         = @PnEjercicio
         And    Isnull(Llave, '') = ''
         Group By Referencia, Fecha_Mov

      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

  -- 2. Valida el total de cargos y abonos del filtro de las polizas

      Begin Try
         Insert Into #tmpCarAbo
        (Moneda, totCar, totAbo)
         Select  m.Moneda, Sum(Case When m.Clave = @w_Cargo
                                    Then m.importe
                                    Else 0
                                End),
                           Sum(Case When m.Clave = @w_Abono
                                    Then m.importe
                                    Else 0
                               End)
         From    dbo.MovDia m With (Nolock)
         Join    dbo.PolDia P With(Nolock)
         On      p.Referencia      = m.Referencia
         And     p.Fecha_Mov       = m.Fecha_mov
         And     p.ejercicio       = m.ejercicio
         And     p.mes             = m.mes
         Where   m.Fecha_mov Between @w_fechaIni And @w_fechaFin
         And     m.ejercicio       = @PnEjercicio
         Group   By m.Moneda;

      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

      Select @w_totalCargo = totCar,
             @w_totalAbono = totAbo
      From   #tmpCarAbo

      If @w_totalCargo !=  @w_totalAbono
         Begin
            Begin Try
               Insert Into #tmpDiferencia
              (ejercicio, mes,   Referencia, Fecha_Mov,
               cargo,     abono, diferencia)
               Select p.Ejercicio, p.mes, p.Referencia, p.Fecha_Mov,
                      Sum(Case When m.Clave = @w_Cargo
                                            Then m.importe
                                            Else 0
                                        End),
                      Sum(Case When m.Clave = @w_Abono
                               Then m.importe
                               Else 0
                          End),
                      Sum(Case When m.Clave = @w_Cargo
                               Then m.importe
                               Else -m.importe
                          End) Diferencia
               From   dbo.MovDia M With(Nolock)
               Join   dbo.PolDia P With(Nolock)
               On      p.Referencia      = m.Referencia
               And     p.Fecha_Mov       = m.Fecha_mov
               And     p.ejercicio       = m.ejercicio
               And     p.mes             = m.mes
               Where   m.Fecha_mov Between @w_fechaIni And @w_fechaFin
               And     m.ejercicio       = @PnEjercicio
               Group By p.Ejercicio, p.mes, p.Referencia,  p.Fecha_Mov
               Having   ABS(Sum(Case When m.Clave = @w_Cargo
                                     Then m.importe
                                     Else -m.importe
                                 End)) != 0
               Order By Ejercicio, mes, Referencia

            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If Isnull(@w_error, 0) != 0
               Begin
                  RollBack transaction
                  Select @w_error, @w_desc_error;

                  Set Xact_Abort    Off
                  Return
               End

            Set @w_mensaje = 'Diferencia de Saldos '
            Begin Try
               Insert Into dbo.logImportarPolErrorTbl
              (Referencia, Fecha_mov,  Llave, mensajeError)
               Select Referencia, Fecha_Mov, '',  @w_mensaje
               From   #tmpDiferencia
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If Isnull(@w_error, 0) != 0
               Begin
                  RollBack transaction
                  Select @w_error, @w_desc_error;

                  Set Xact_Abort    Off
                  Return
               End

         End  -- @w_totalCargo !=  @w_totalAbono

    -- Se agrega validacion para que no se dupliquen polizas

      Set @w_mensaje = 'La poliza ya existe en Movimientos';

      Begin Try
         Insert Into dbo.logImportarPolErrorTbl
        (Referencia, Fecha_mov,  Llave, mensajeError)
         Select Referencia, Fecha_Mov, '',  @w_mensaje
         From   dbo.PolDia a With (Nolock)
         Where  Exists ( Select Top 1 1
                         From   dbo.Poliza With (Nolock)
                         Where  Referencia      = a.Referencia
                         And    Fecha_Mov       = a.Fecha_mov
                         And    ejercicio       = a.ejercicio
                         And    mes             = a.mes)
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

    -- Se agrega validacion de cuentaas contables válidas.

      Begin Try
         Set @w_mensaje = 'La Cuenta no existe en Catalogo Auxiliar'
         Insert Into dbo.logImportarPolErrorTbl
        (Referencia, Fecha_mov,  Llave, mensajeError)
         Select Referencia, Fecha_Mov, llave,  @w_mensaje
         From   dbo.MovDia a With (Nolock)
         Where  Not Exists ( Select Top 1 1
                             From   dbo.Catalogo With (Nolock)
                             Where  ejercicio       = a.ejercicio
                             And    mes             = a.mes
                             And    llave           = a.llave
                             And    moneda          = a.moneda)
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

    --ZCMC 21/09/2022. Se cambia la obtencion del valor de la variable para el numero correcto de errores.

      Select @w_ContNoPol = Count (1)
      From (Select Distinct referencia, fecha_mov
            From   dbo.logImportarPolErrorTbl With(Nolock)
            Where  fecha_mov Between @w_fechaIni And @w_fechaFin) pol

 -- Actualizar las tablas Poldia con los errores encontrados durante el Proceso.

      Begin Try
         Update a
         Set    a.CausaRechazo = b.mensajeError
         From   dbo.polDia                 a With (Nolock)
         Join   dbo.logImportarPolErrorTbl b With (Nolock)
         On     b.Referencia = a.Referencia
         And    b.Fecha_Mov  = a.Fecha_Mov
         Where  a.ejercicio  = @PnEjercicio;

      End Try


      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

 -- Actualizar las tablas Movdia con los errores encontrados durante el Proceso.

      Begin Try
         Update a
         Set    a.idCausaRechazo = b.mensajeError
         From   dbo.MovDia                 a With (Nolock)
         Join   dbo.logImportarPolErrorTbl b With (Nolock)
         On     a.Referencia = b.Referencia
         And    a.Fecha_Mov  = b.Fecha_Mov
         Where  a.ejercicio  = @PnEjercicio;

      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End


   --Agrega el Contenido del cabecero de la póliza

      Begin Try
         Insert Into #tmpPoliza
        (Referencia,    NewReferencia,   Fecha_Mov, Fecha_Cap,
         Concepto,      Cargos,          Abonos,    TCons,
         Usuario,       TipoPoliza,      Documento, Usuario_cancela,
         Fecha_cancela, Status,          Mes_Mov,   Ejercicio,
         mes,           TipoPolizaConta, FuenteDatos)
         Select  Referencia,    '',              Fecha_mov,  @w_fechaAct,
                 Concepto,      Cargos,          Abonos,     TCons,
                 @w_usuario,    TipoPoliza,      Documento,  Usuario_cancela,
                 Fecha_cancela, Status,          Mes_Mov,    Ejercicio,
                 mes,           TipoPolizaConta, FuenteDatos
         From   dbo.PolDia With(Nolock)
         Where  CausaRechazo Is NULL
         And    Ejercicio      = @PnEjercicio
         And    Fecha_Mov Between @w_fechaIni And @w_fechaFin
         Order  By Fecha_mov, TipoPolizaConta
         Set  @w_maxId = @@Identity
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

   --Agrega el Contenido del detalle de la póliza

      Begin Try
          Insert Into #tmpMovimientos
         (Referencia,      Cons,             Moneda,        Fecha_Mov,
          Llave,           Concepto,         Importe,       Documento,
          Clave,           FecCap,           Sector_id,     Sucursal_id,
          Region_id,       Importe_Cargo,    Importe_Abono, Descrip,
          TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     ejercicio,
          mes)
          Select Referencia,      Cons,             Moneda, Fecha_mov,
                 Llave,           Concepto,         Importe, Documento,
                 (Case When  Clave = 'D' Then 'C' Else 'A' End) Clave, @w_fechaAct,
                 Isnull(Sector_id, '00'), Sucursal_id,
                 Region_id,       Importe_Cargo,    Importe_Abono, Descripcion,
                 TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     ejercicio,
                 mes
          From   dbo.movDia With(Nolock)
          Where  idCausaRechazo  Is Null
          And    Fecha_mov  Between @w_fechaIni And @w_fechaFin
          And    Ejercicio        = @PnEjercicio
          Order  By mes, Fecha_mov, TipoPolizaConta

      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

   --Ciclo para obtener datos del tipo de comprobante

      While @w_minId  < @w_maxId
      Begin
         Set @w_minId = @w_minId + 1;

         Select @w_Referencia  = Referencia,
                @w_Fecha_Mov   = Fecha_Mov,
                @w_Mes_Mov     = Mes_Mov,
                @w_TipoPol     = TipoPoliza,
                @w_Ejercicio   = Ejercicio,
                @w_mes         = mes
         From   #tmpPoliza
         Where  Id = @w_minId;
         If @@Rowcount = 0
            Begin
               Break
            End

         If @w_TipoPol = 'PDI'
            Begin
               Select @w_contPDI = contador
               From   dbo.ControlPoliza With (Nolock)
               Where  TipoComprobante = @w_TipoPolPDI
               And    Ejercicio       = @w_Ejercicio
               And    Mes             = @w_mes;
               If @@Rowcount = 0
                  Begin
                     Set @w_contPDI = 0
                  End

               Select @w_contPDI = @w_contPDI + 1,
                      @w_NewRef  = Concat(@w_TipoPol, Format(@w_contPDI, '000000'))
            End

         If @w_TipoPol = 'PEG'
            Begin
               Select @w_contPEG = contador
               From   dbo.ControlPoliza With (Nolock)
               Where  TipoComprobante = @w_TipoPolPEG
               And    Ejercicio       = @w_Ejercicio
               And    Mes             = @w_mes;
               If @@Rowcount = 0
                  Begin
                     Set @w_contPEG = 0
                  End

               Select @w_contPEG = @w_contPEG + 1,
                      @w_NewRef  = Concat(@w_TipoPol, Format(@w_contPEG, '000000'))
            End

         If @w_TipoPol = 'PIN'
            Begin
               Select @w_contPIN = contador
               From   dbo.ControlPoliza With (Nolock)
               Where  TipoComprobante = @w_TipoPolPIN
               And    Ejercicio       = @w_Ejercicio
               And    Mes             = @w_mes;
               If @@Rowcount = 0
                  Begin
                     Set @w_contPIN = 0
                  End

               Select @w_contPIN = @w_contPIN + 1,
                      @w_NewRef  = Concat(@w_TipoPol, Format(@w_contPIN, '000000'))
            End

         Update #tmpPoliza
         Set    NewReferencia = @w_NewRef
         Where  Id = @w_minId


    --Se agrega Validacion parametro para actualizacion en tabla de SET 14/05/2021

         If @w_para392 = 1
            Begin
               Set @w_sql = Concat('Update set_dalton.dbo.zmovdia ',
                                   'Set    no_poliza_compensa  = ', @w_comilla, @w_NewRef,     @w_comilla, ' ',
                                   'Where  referencia          = ', @w_comilla, @w_Referencia, @w_comilla, ' ',
                                   'And    FuenteDatos         = ', @w_comilla, 'SET',         @w_comilla);
               Begin Try
                  Execute (@w_sql)
               End Try

               Begin Catch
                  Select  @w_Error      = @@Error,
                          @w_linea      = Error_line(),
                          @w_desc_error = Substring (Error_Message(), 1, 200)

               End   Catch

               If Isnull(@w_error, 0) != 0
                  Begin
                     RollBack transaction
                     Select @w_error, @w_desc_error;

                     Set Xact_Abort    Off
                     Return
                  End

            End -- @w_para392 = 1

    --FIN DE ACTUALIZACION 14/05/2021

         Begin Try
            Update dbo.ControlPoliza
            Set    contador = Case When @w_TipoPol = 'PDI'
                                   Then @w_contPDI
                                   When @w_TipoPol = 'PEG'
                                   Then @w_contPEG
                                   When @w_TipoPol = 'PIN'
                                   Then @w_contPIN
                                   Else 0
                              End
            Where  TipoComprobante = @w_TipoPol;
         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If Isnull(@w_error, 0) != 0
            Begin
               RollBack transaction
               Select @w_error, @w_desc_error;

               Set Xact_Abort    Off
               Return
            End

      End -- Fin Ciclo

      --Actualizar la nueva Referencia.

      Update a
      Set    NewReferencia = b.NewReferencia
      From   #tmpMovimientos a
      Join   #tmpPoliza      b
      On     b.ejercicio  = a.ejercicio
      And    b.mes        = a.mes
      And    b.Referencia = a.Referencia
      And    b.Fecha_Mov  = a.Fecha_Mov

       --Inserta en la tabla Relacion

      Begin Try
         Insert Into dbo.RelacionImp
        (Referencia, Fecha_Mov,   Fecha_Cap, NewReferencia,
         Usuario,    FuenteDatos, FechaImportacion, Ejercicio, mes)
         Select  Referencia, Fecha_Mov, Fecha_Cap, NewReferencia, Usuario, FuenteDatos, @w_fechaAct,
		         Ejercicio,  mes
         From    #tmpPoliza
         Order by Id
		 Set @w_registrosImp = @@Identity

      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

         ----Agrega el Contenido del cabecero de la póliza

      Begin Try
         Insert Into dbo.polizaAnio
        (Referencia, Fecha_Mov, Fecha_Cap,       Concepto,
         Cargos,     Abonos,    TCons,           Usuario,
         TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela,
         Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos,
         Ejercicio,  Mes)
         Select NewReferencia, Fecha_Mov, Fecha_Cap,       Concepto,
                Cargos,        Abonos,    TCons,           Usuario,
                TipoPoliza,    Documento, Usuario_cancela, Fecha_cancela,
                Status,        Mes_Mov,   TipoPolizaConta, FuenteDatos,
                ejercicio,     mes
         From   #tmpPoliza
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

            --Agrega el Contenido al detalle de la póliza

      Begin Try
         Insert Into dbo.MovimientosAnio
        (Referencia,      Cons,             Moneda,        Fecha_mov,
         Llave,           Concepto,         Importe,       Documento,
         Clave,           FecCap,           Sector_id,     Sucursal_id,
         Region_id,       Importe_Cargo,    Importe_Abono, Descripcion,
         TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     Ejercicio,
         mes)
         Select NewReferencia, Cons,               Moneda,        Fecha_Mov,
                Llave,         Concepto,           Importe,       Documento,
                Clave,         FecCap,             Sector_id,     Sucursal_id,
                Region_id,     Importe_Cargo,      Importe_Abono, Descrip,
                TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     Ejercicio,
                Mes
         From   #tmpMovimientos
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End


          --ZCMC 21/09/2022. Se modifica tabla que controla la importacion, colocando la fecha de la ejecucion del SP

      Begin Try
         Insert Into dbo.controlImpPolTbl
        (Fecha_Mov, Polizas_Imp, polizas_no_imp)
         Select @w_fechaAct, @w_registrosImp, @w_ContNoPol
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

        --Inserta en la tabla Relacion
        --CHUR/ZCMC 11/05/2021 Se descomentan las dos lineas del insert


 -- Actualizar Pólizas (Encabezado) con Errores.

      Begin Try
         Insert Into dbo.PolDiaError
        (Referencia, Fecha_Mov, Fecha_Cap,       Concepto,
         Cargos,     Abonos,    TCons,           Usuario,
         TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela,
         Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos,
         Ejercicio,  Mes,       Causa_Rechazo,   Fecha_importacion,
         UltActal)
         Select Referencia, Fecha_Mov, Fecha_Cap, Concepto,
                Cargos,     Abonos,    TCons,     Usuario,
                TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela,
                Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos,
                Ejercicio,  Mes,       CausaRechazo,    @w_fechaAct,
                @w_fechaAct
         From   dbo.PolDia With(Nolock)
         Where  CausaRechazo  Is not Null
         And    fecha_mov Between @w_fechaIni And @w_fechaFin
         And    Ejercicio       = @PnEjercicio;
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

 -- Actualizar Pólizas (Encabezado) con Errores.

      Begin Try
         Insert Into dbo.MovDiaError
        (Referencia,      Cons,             Moneda,            Fecha_mov,
         Llave,           Concepto,         Importe,           Documento,
         Clave,           FecCap,           Sector_id,         Sucursal_id,
         Region_id,       Importe_Cargo,    Importe_Abono,     Descripcion,
         TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,         Ejercicio,
         Mes,             Causa_Rechazo,    Fecha_importacion, UltActal)
         Select Referencia,      Cons,             Moneda,        Fecha_mov,
                Llave,           Concepto,         Importe,       Documento,
                Clave,           FecCap,           Sector_id,     Sucursal_id,
                Region_id,       Importe_Cargo,    Importe_Abono, Descripcion,
                TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     Ejercicio,
                Mes,             idCausaRechazo,   Null,          @w_fechaAct
         From   dbo.MovDia With(Nolock)
         Where  idCausaRechazo Is not Null
         And    fecha_mov Between @w_fechaIni And @w_fechaFin
         And    Ejercicio       = @PnEjercicio;
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

     --Eliminar las tablas de MovDia

      Begin Try
         Delete dbo.MovDia
         Where (idCausaRechazo    Is Null
         Or     idCausaRechazo like '%La poliza ya existe%')
         And    fecha_mov   Between @w_fechaIni And @w_fechaFin
         And    Ejercicio         = @PnEjercicio;
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

     --Eliminar las tablas de MovDia

      Begin Try
         Delete dbo.PolDia
         Where (CausaRechazo   Is Null
         Or     CausaRechazo like '%La poliza ya existe%')
         And    fecha_mov Between @w_fechaIni And @w_fechaFin
         And    Ejercicio       = @PnEjercicio;
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            RollBack transaction
            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

     While @w_secuencia <= @w_registrosImp
      Begin
         Set @w_secuencia = @w_secuencia + 1;
         Begin Try
            Insert Into dbo.Relacion_Poliza_Interna_Externa
           (Referencia, Fecha_Mov, Fecha_Cap, Referencia_Contable, Usuario, FuenteDatos)
            Select Referencia, Fecha_Mov, Fecha_Cap, NewReferencia, Usuario, FuenteDatos
            From   dbo.RelacionImp a With(Nolock)
            Where  idRelacion = @w_secuencia
            And    Not Exists (Select top 1 1
                               From   dbo.Relacion_Poliza_Interna_Externa b With(Nolock)
                               Where  b.Referencia = a.referencia
                               And    b.Fecha_Mov  = a.Fecha_Mov )

         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If Isnull(@w_error, 0) != 0
            Begin
               RollBack transaction
               Select @w_error, @w_desc_error;

               Set Xact_Abort    Off
               Return
            End

        --ZCMC/MZB 12/10/2022. Se crea nuevo campo para relacionar polizas entre SICCORP Y SisArrendaCredito

        If @w_instalado = 1  -- Instalado SisArrendaCredito
           Begin
              Select @w_consecutivo = @w_consecutivo + 1,
                     @w_ConsReferencia = Concat (Format(Day(@w_fechaAct), '00'), Format(Month(@w_fechaAct), '00'), Year( @w_fechaAct ) % 100,
                                                 Format(@w_consecutivo,'00000'))

              Set @w_sql = Concat('Update a ' ,
                                  'Set    iddegasto = ', @w_ConsReferencia, ' ',
                                  'From   SisArrendaCredito.dbo.Poliza a With (Nolock) ',
                                  'Join   dbo.RelacionImp              b With (Nolock) ',
                                  'On     b.Referencia  = a.Referencia_Exporta Collate SQL_Latin1_General_CP1_CI_AS ',
                                  'And    Cast(b.fecha_mov As Date) = Cast(a.fechaContable As Date) ',
                                  'Where  b.IdRelacion  = ', @w_secuencia, ' ',
                                  'And    b.ejercicio   = ', @PnEjercicio, ' ',
                                  'And    Cast(b.fechaImportacion As Date) Between ', @w_comilla, Cast(@w_fechaIni As Date), @w_comilla ,
                                                                             ' And ', @w_comilla, Cast(@w_fechaFin As Date), @w_comilla);
              Begin Try
                 Execute (@w_sql)
              End   Try

              Begin Catch
                 Select  @w_Error      = @@Error,
                         @w_linea      = Error_line(),
                         @w_desc_error = Substring (Error_Message(), 1, 200)

              End   Catch

              If Isnull(@w_error, 0) != 0
                 Begin
                    RollBack transaction
                    Select @w_error, @w_desc_error;

                    Set Xact_Abort    Off
                    Return
                 End

           End

      End   -- @w_secuencia <= @w_registrosImp

   Commit transaction

   Print 'Ok'

   Set Xact_Abort    Off
   Return

End
1> 