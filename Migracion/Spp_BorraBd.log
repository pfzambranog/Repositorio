1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> --
-- Funcionalidad: Borra Base de datos.
-- Fecha:         03/10/2024
-- Genera:        Pedro Zambrano
-- --------------------------------------------------

Create Or Alter Procedure dbo.Spp_BorraBd
(@PsBaseDatos    Sysname,
 @PnEstatus      Integer        = 0 Output,
 @PsMensaje      Varchar(250)   = 0 Output)
As
Declare
   @w_Error             Integer,
   @w_desc_error        Varchar( 250),
   @w_sql               Nvarchar(Max),
   @w_param             Nvarchar(750),
   @w_comilla           Char(1),
   @w_char92            Char(1),
   @w_linea             Integer,
   @w_existe            Integer;

Begin
   Set Nocount       On
   Set Xact_Abort    On
   Set Ansi_Nulls    Off

   Select @PnEstatus = 0,
          @PsMensaje = '',
          @w_linea   = 0,
          @w_comilla = Char(39),
          @w_char92  = Char(92);
--
--
--

   If Exists ( Select Top 1 1
               From   sys.Databases
               Where  name  = @PsBaseDatos)
      Begin
         Select @w_sql   = Concat('Select @o_existe = count(1) ',
                                  'From  ', @PsBaseDatos, '.sys.extended_properties ',
                                  'Where class = 0'),
                @w_param = '@o_existe Integer Output';

         Begin Try
            Execute Sp_ExecuteSQL @w_sql, @w_param, @o_existe = @w_existe Output;
         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End Catch

         If IsNull(@w_error, 0) <> 0
            Begin
               Select @PnEstatus = @w_error,
                      @PsMensaje = Concat('Error.: ', @w_Error, ' ', @w_desc_error, ' en Línea ', @w_linea);

               Set Xact_Abort Off
               Return
            End

         If @w_existe = 1
            Begin
               Set @w_sql = Concat(@PsBaseDatos, '.sys.sp_dropextendedproperty @name=N',
                                   @w_comilla, 'MS_Description', @w_comilla);

               Begin Try
                  Execute (@w_sql)
               End Try

               Begin Catch
                  Select  @w_Error      = @@Error,
                          @w_linea      = Error_line(),
                          @w_desc_error = Substring (Error_Message(), 1, 200)

               End Catch

               If IsNull(@w_error, 0) <> 0
                  Begin
                     Select @PnEstatus = @w_error,
                            @PsMensaje = Concat('Error.: ', @w_Error, ' ', @w_desc_error, ' en Línea ', @w_linea);

                     Set Xact_Abort Off
                     Return
                  End
            End

         Set @w_sql = Concat('Alter Database ', @PsBaseDatos, ' Set Single_user With Rollback Immediate')

         Begin Try
            Execute (@w_sql)
         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End Catch

         If IsNull(@w_error, 0) <> 0
            Begin
               Select @PnEstatus = @w_error,
                      @PsMensaje = Concat('Error.: ', @w_Error, ' ', @w_desc_error, ' en Línea ', @w_linea);

               Set Xact_Abort Off
               Return
            End

         Set @w_sql = Concat('Drop  Database ', @PsBaseDatos);

         Begin Try
            Execute (@w_sql)
         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End Catch

         If IsNull(@w_error, 0) <> 0
            Begin
               Select @PnEstatus = @w_error,
                      @PsMensaje = Concat('Error.: ', @w_Error, ' ', @w_desc_error, ' en Línea ', @w_linea);

               Set Xact_Abort Off
               Return
            End

      End

   Set Xact_Abort Off
   Return
End
1> 