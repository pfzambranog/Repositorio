1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> 165> 166> 167> 168> 169> 170> 171> 172> 173> 174> 175> 176> 177> 178> 179> 180> --
-- Script de llenado de la tabla control.
--

Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anioFinal               Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mesIni                  Tinyint,
   @w_mes                     Tinyint,
   @w_mesFin                  Tinyint,
   @w_mesProc                 Tinyint,
   @w_idEstatus               Tinyint,
   @w_inicio                  Tinyint,
   @w_comilla                 Char(1),
   @w_usuario                 Nvarchar(20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_desc_error              Varchar( 250),
   @w_idusuario               Varchar( Max);

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anioIni   = 0,
          @w_anio      = 0,
          @w_inicio    = 0,
          @w_idEstatus = 2,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_tabla     = 'Control';;

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End


   If dbo.Fn_existe_tabla(@w_tabla ) = 0
      Begin
         Goto Salida
      End

   Select @w_anioIni  = Datepart(yyyy, parametroFecha),
          @w_mesProc  = Datepart(mm,   parametroFecha)
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 11;
   
   Select @w_anioFinal = Cast(Substring(parametroChar, 1, 4) As Smallint),
          @w_mesFin    = Cast(Substring(parametroChar, 6, 2) As Tinyint)
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 12;
   
   Begin Transaction
      While @w_anioIni <= @w_anioFinal
      Begin
         If Exists ( Select Top 1 1
                     From   dbo.Control
                     Where  ejercicio = @w_anioIni)
            Begin
               Begin Try
                  Delete dbo.Control
                  Where  ejercicio = @w_anioIni
               End Try

               Begin Catch
                  Select  @w_Error      = @@Error,
                          @w_linea      = Error_line(),
                          @w_desc_error = Substring (Error_Message(), 1, 200)

               End   Catch

               If @w_error != 0
                  Begin
                     Rollback Transaction
                     Select @w_error, @w_desc_error;

                     Goto Salida
                  End

            End
             
         Select @w_mes    = max(valor),
                @w_mesIni = min(Valor)
         From   catCriteriosTbl
         Where  criterio = 'mes'
         And    idEstatus = 1;

           
         While  @w_mesIni <= @w_mes
         Begin

         If @w_inicio = 0
            Begin
               Select @w_mesIni = @w_mesProc,
                      @w_inicio = 1;
            End

            If @w_mesIni  = @w_mesFin      And
               @w_anioIni = @w_anioFinal
               Begin
                  Set @w_idEstatus = 1
               End

            Begin Try
               Insert Into dbo.Control
              (Ejercicio, Mes, idEstatus, usuario)
               Select @w_anioIni, @w_mesIni, @w_idEstatus, @w_usuario
               
               Set @w_registros = @w_registros + @@Rowcount;
            End  Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)
            
            End   Catch

            If @w_error != 0
               Begin
                  Rollback Transaction
                  Select @w_error, @w_desc_error;
            
                  Goto Salida
               End

            If @w_idEstatus = 1
               Begin
                  Break
               End

            Set @w_mesIni += 1;


         End

         Set @w_anioIni += 1;

Siguiente:

      End

   Commit Transaction

   Select @w_registros;

Salida:

   Set Xact_Abort Off
   Return

End
             
 ----------- 
          30 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> Declare
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_idusuario               Varchar(  Max),
   @w_desc_error              Varchar(  750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On
   
   Set @w_ultactual = Getdate()
   
   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.CatalogoConsolidado)
         Begin
            Begin Try
               Delete dbo.Catalogo
               Delete dbo.CatalogoAuxiliar
			   Delete dbo.CatalogoAuxiliarHist
               Delete dbo.CatalogoAuxiliarCierreTbl
               Delete dbo.CatalogocierreTbl
               Delete dbo.CatalogoCtasContabElectroTbl
               Delete dbo.CatalogoNaturalezaContTbl
               Delete dbo.CatAuxExterno
               Delete dbo.ControlAuxiliarCC
               Delete dbo.MovDia
               Delete dbo.Movimientos
               Delete dbo.MovimientosCaptura
               Delete dbo.MovimientosErrores
               Delete dbo.MapeoCodigoAgrupador
               Delete dbo.AuxiliaresCorporativos
			   Delete dbo.MapeoCodigoAgrupador
	           Delete dbo.CatalogoAuxiliarCierre
	           Delete dbo.MovimientosHist
	           Delete dbo.BalanzaComprobacionTbl
               Delete dbo.Cuentas_predeterminadas
               Delete dbo.CatalogoConsolidado
            End Try
           
            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)
      
            End   Catch
      
            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  Rollback Transaction
      
                  Goto Salida
               End
         End

      Begin Try
         Insert Into dbo.CatalogoConsolidado
        (numerodecuenta, moneda_id,       descripcion, interdepartamental,
         naturaleza,     CodigoAgrupador, idEstatus,   ultactual,   user_id)
         Select numerodecuenta, '00' moneda_mex, descripcion, interdepartamental,
                naturaleza,     Null CodigoAgrupador,      activo,
                @w_ultactual,   @w_usuario
         From   DB_GEN_DES.dbo.catCon
         Set @w_registros = @@Rowcount;
      End Try
     
      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error, @w_desc_error;
            Rollback Transaction

            Goto Salida
         End

   Commit Transaction

   Select @w_registros "Registros Insertados";

Salida:

   Set Xact_Abort  Off
   Return

End
 Registros Insertados 
 -------------------- 
                19305 

1> 2> 
1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> 165> 166> 167> 168> 169> 170> 171> 172> 173> 174> 175> 176> 177> 178> 179> 180> 181> 182> 183> 184> 185> 186> 187> 188> 189> 190> 191> 192> 193> 194> 195> 196> 197> 198> 199> 200> 201> 202> 203> 204> 205> 206> 207> 208> 209> 210> 211> 212> 213> 214> 215> 216> 217> 218> 219> 220> 221> 222> 223> 224> 225> 226> 227> 228> 229> 230> 231> 232> 233> 234> 235> 236> 237> 238> 239> 240> 241> 242> 243> 244> 245> 246> 247> 248> 249> 250> 251> 252> 253> 254> 255> 256> 257> 258> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_regAux                  Integer,
   @w_regCat                  Integer,
   @w_registrosDup            Integer,
   @w_mes                     Tinyint,
   @w_mesProc                 Tinyint,
   @w_mesMax                  Tinyint,
   @w_linea                   Integer,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_mensaje                 Varchar(  Max),
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime,
   @w_inicio                  Bit;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regAux    = 0,
          @w_regCat    = 0,
          @w_inicio    = 1,
          @w_ultactual = Getdate()

   Select @w_anioIni  = Datepart(yyyy, parametroFecha),
          @w_mesProc  = Datepart(mm,   parametroFecha)
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 11;

   Select @w_anioFin = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error   = 9999,
                 @w_mensaje = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Goto Salida
      End

   Select @w_mesMax    = Max(valor)
   From   catCriteriosTbl
   Where  criterio = 'mes'
   And    idEstatus = 1;

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.Catalogo)
         Begin
            Begin Try
               Truncate table dbo.Catalogo
            End   Try

            Begin Catch
               Select  @w_Error   = @@Error,
                       @w_linea   = Error_line(),
                       @w_mensaje = Substring (Error_Message(), 1, 200)

            End   Catch

             If Isnull(@w_Error, 0) <> 0
                Begin
                   Select @w_Error Error, Concat('Error.: ', @w_Error, ' ', @w_mensaje, ' en Línea ', @w_linea) Mensaje;

                   Rollback Transaction
                   Set Xact_Abort Off
                   Goto Salida
                End

         End

       While @w_anioIni  <= @w_anioFin
       Begin

          While @w_mes <= @w_mesMax
          Begin
             If @w_inicio = 1
                Begin
                   Select @w_mes     = @w_mesProc,
                          @w_inicio  = 0;
                End

             Select @w_registrosDup = 0,
                    @w_chmes        = dbo.Fn_BuscaMes (@w_mes),
                    @w_tabla       = Case When @w_mes = 0
                                          Then Concat('catIni', @w_anioIni)
                                          When @w_mes = 13
                                          Then Concat('catFin', @w_anioIni)
                                          Else Concat('cat', @w_chmes, @w_anioIni)
                                     End;

             If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
                Begin
                   Goto Siguiente
                End

             Set @w_sql = Concat('Select Distinct Llave, ', @w_comilla, '00', @w_comilla, ' Moneda,   Niv,        Descrip, ',
                                        'SAnt,         Car,        Abo,        SAct, ',
                                        'FecCap,       CarProceso, AboProceso, SAntProceso, ',
                                        'CarExt,       AboExt,     SProm,      SPromAnt, ',
                                        'Nivel_sector, SProm2,     SProm2Ant, ',
                                         @w_anioIni, ', ', @w_mes, ' ',
                                 'From   Ejercicio_DES.dbo.', @w_tabla, ' a ',
                                 'Where  Niv In (0, 1) ',
                                 'And    Exists (Select Top 1 1 ',
                                                'From   dbo.catalogoConsolidado ',
                                                'Where  numerodecuenta = a.Llave ',
                                                'And    moneda_id      = ', @w_comilla, '00', @w_comilla, ')')
             Begin Try
                Insert Into dbo.Catalogo
               (Llave,        Moneda,     Niv,        Descrip,
                SAnt,         Car,        Abo,        SAct,
                FecCap,       CarProceso, AboProceso, SAntProceso,
                CarExt,       AboExt,     SProm,      SPromAnt,
                Nivel_sector, SProm2,     Sprom2Ant,  Ejercicio,
                Mes)
                Execute(@w_sql)

                Set @w_registros = @w_registros + @@Rowcount;

             End   Try

             Begin Catch
                Select  @w_Error   = @@Error,
                        @w_linea   = Error_line(),
                        @w_mensaje = Substring (Error_Message(), 1, 200)

             End   Catch

             If Isnull(@w_Error, 0) <> 0
                Begin
                   Rollback Transaction
                   Select @w_Error Error, Concat('Error.: ', @w_Error, ' ', @w_mensaje, ' en Línea ', @w_linea) Mensaje;

                   Goto Salida
                End


             Set @w_sql = Concat('Update dbo.CatalogoConsolidado ',
                                 'Set    codigoAgrupador = b.codigoAgrupador ',
                                 'From   dbo.CatalogoConsolidado  a ',
                                 'Join   Ejercicio_DES.dbo.', @w_tabla, ' b ',
                                 'On     b.llave = a.numerodecuenta ',
                                 'Where  b.codigoAgrupador Is Not Null');

             Begin Try
                Execute(@w_sql)
                Set @w_regAux = @w_regAux + @@Rowcount;

             End   Try

             Begin Catch
                Select  @w_Error   = @@Error,
                        @w_mensaje = Error_Message()
             End Catch

             If @w_error != 0
                Begin
                   Rollback Transaction

                   Select @w_error, @w_mensaje;

                   Goto Salida
                End

             Set @w_mes += 1;

Siguiente:

          End


          Select @w_anioIni += 1,
                 @w_mes      = 0;

       End

       Begin Try
          Insert Into dbo.Ejercicios
         (Ejercicio, idEstatus)
          Select Distinct ejercicio, 0
          From   dbo.Catalogo a With (Nolock)
          Where  Not Exists ( Select Top 1 1
                              From   dbo.Ejercicios With (Nolock)
                              Where  ejercicio = a.ejercicio);
       End   Try

       Begin Catch
          Select  @w_Error   = @@Error,
                  @w_mensaje = Error_Message()
       End Catch

       If @w_error != 0
          Begin
             Rollback Transaction

             Select @w_error, @w_mensaje;

             Goto Salida
          End

       Begin Try
          Insert Into dbo.control
         (Ejercicio, Mes, idEstatus, usuario)
          Select Distinct ejercicio, mes, 0, @w_usuario
          From   dbo.Catalogo a With (Nolock)
          Where  Not Exists ( Select Top 1 1
                              From   dbo.Control With (Nolock)
                              Where  ejercicio = a.ejercicio
                              And    mes       = a.mes);
       End   Try

       Begin Catch
          Select  @w_Error   = @@Error,
                  @w_mensaje = Error_Message()
       End Catch

       If @w_error != 0
          Begin
             Rollback Transaction

             Select @w_error, @w_mensaje;

             Goto Salida
          End

   Commit Transaction

   Select @w_registros "Nuevos Registros";

Salida:

   Set Xact_Abort    On
   Return

End
 Nuevos Registros 
 ---------------- 
           435808 

1> 2> 
1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> Declare
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_regCat                  Integer,
   @w_desc_error              Varchar(  Max),
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_ultactual = Getdate(),
          @w_regCat    = 0;

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction

      Begin Try
         Delete dbo.CatalogoNaturalezaContTbl
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error, @w_desc_error;
            Rollback Transaction

            Goto Salida
         End

      Begin Try
         Insert Into dbo.CatalogoNaturalezaContTbl
        (Naturaleza_id, nom_naturaleza, rango_id,   rango,
         llaveinicila,  llavefinal,     tipoCuenta, llave,
         moneda_id)
        Select Naturaleza_id, nom_naturaleza, rango_id,   rango,
               llaveinicila,  llavefinal,     tipoCuenta, llave,
               '00' moneda_id
        From   ejercicio_des.dbo.CatConNaturaleza a
        Set @w_registros = @@Rowcount
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error, @w_desc_error;
            Rollback Transaction

            Goto Salida
         End

   Commit Transaction

   Select @w_registros "Registros Nuevos"

Salida:

  Set Xact_Abort Off
  Return

End
 Registros Nuevos 
 ---------------- 
            15130 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> Declare
   @w_error                   Integer,
   @w_registros               Integer,
   @w_regCat                  Integer,
   @w_linea                   Integer,
   @w_desc_error              Varchar(  Max),
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   If Exists ( Select Top 1 1
               From   dbo.CatalogoCtasContabElectroTbl)
      Begin
         Begin Try
            Truncate table dbo.CatalogoCtasContabElectroTbl
         End Try
      
         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_desc_error = Error_Message()
         End   Catch
      
         If @w_error != 0
            Begin
               Select @w_error, @w_desc_error;
      
               Goto Salida
            End
      End

   Begin Transaction


      Begin Try
         Insert Into dbo.CatalogoCtasContabElectroTbl
        (CodigoAgrupador, llave, moneda_id, descripcion,
         nivel,           naturaleza)
        Select CodigoAgrupador, llave,       '00' moneda_id, Descrip,
               nivel,           naturaleza
        From   ejercicio_des.dbo.CatCuentasContaElec a
        Where  Exists ( Select Top 1 1
                        From   dbo.CodigoAgrupadorSAT
                        Where  CodigoAgrupador = a.CodigoAgrupador)
        And    Exists (Select Top 1 1
                       From   dbo.catalogoConsolidado
                       Where  numerodecuenta = a.Llave 
                       And    moneda_id      = 1)
        Set @w_registros = @@Rowcount
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)
  
      End   Catch
  
      If @w_error != 0
         Begin
            Select @w_error, @w_desc_error;
            Rollback Transaction
  
            Goto Salida
         End

   Commit Transaction

   Select @w_registros "Registros Nuevos", @w_regCat "Nuevos Registros"
   
Salida:

  Set Xact_Abort    Off
  Return

End
 Registros Nuevos Nuevos Registros 
 ---------------- ---------------- 
                0             NULL 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> 165> 166> 167> 168> 169> 170> 171> 172> 173> 174> 175> 176> 177> 178> 179> 180> 181> 182> 183> 184> 185> 186> 187> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_mes                     Integer,
   @w_registros               Integer,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_desc_error              Varchar(Max),
--
   @w_linea                   Integer,
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = -1,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_ultactual = Getdate();

   Select @w_anioFin = ejercicio,
          @w_anioIni = ejercicio -1
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Goto Salida
      End

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Create Table #TempErrores
   (secuencia   Integer Not Null Identity (1, 1) Primary Key,
    Tabla       Sysname,
    comando     Varchar(Max),
    mensaje     Varchar(Max));

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.CatalogoAuxiliar)
         Begin
            Begin Try
               Delete dbo.CatalogoAuxiliar
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      While @w_anioIni  < @w_anioFin
      Begin
         Select @w_mes     = -1,
                @w_anioIni = @w_anioIni + 1;

         While @w_mes < 13
         Begin
            Select @w_mes   = @w_mes + 1,
                   @w_chmes = dbo.Fn_BuscaMes (@w_mes),
                   @w_tabla = Case When @w_mes = 0
                                   Then Concat('CatAuxIni', @w_anioIni)
                                   When @w_mes = 13
                                   Then Concat('CatAuxFin', @w_anioIni)
                                   Else Concat('CatAux', @w_chmes, @w_anioIni)
                              End;

            If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
               Begin
                  Goto Siguiente
               End

            Set @w_sql = Concat('Select Distinct Llave, ', @w_comilla, '00', @w_comilla, ' Moneda,   Niv,          Sector_id, ',
                                       'Sucursal_id, ',
                                       'Case When Region_id = 202 Then 5555 Else Region_id End Region_id, ',
                                       'Descrip,     SAnt, ',
                                       'Car,         Abo,        SAct,        FecCap, ',
                                       'CarProceso,  AboProceso, SAntProceso, CarExt, ',
                                       'AboExt,      SProm,      SPromAnt,    SProm2, ',
                                       'SProm2Ant, ', @w_anioIni, ', ', @w_mes, ' ',
                               'From   Ejercicio_DES.dbo.', @w_tabla, ' a ',
                               'Where  Exists      (Select Top 1 1 ',
                                                   'From   dbo.CatalogoConsolidado ',
                                                   'Where  numerodecuenta = a.llave ',
                                                   'And    Moneda_id      = ', @w_comilla, '00', @w_comilla, ') ');

            Begin Try
               Insert Into dbo.CatalogoAuxiliar
              (Llave,       Moneda,     Niv,         Sector_id,
               Sucursal_id, Region_id,  Descrip,     SAnt,
               Car,         Abo,        SAct,        FecCap,
               CarProceso,  AboProceso, SAntProceso, CarExt,
               AboExt,      SProm,      SPromAnt,    SProm2,
               SProm2Ant,   ejercicio,  mes)
               Execute(@w_sql)
               Set @w_registros = @w_registros + @@Rowcount;
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_desc_error = Error_Message()
            End   Catch

            If @w_error != 0
               Begin
                  Insert Into #TempErrores
                 (Tabla, comando, mensaje)
                 Select @w_tabla, @w_sql, @w_desc_error

                 Select @w_error      = 0,
                        @w_desc_error = '';

                 Goto Siguiente
               End
         End

Siguiente:

      End

   Commit Transaction

   Select @w_registros RegistrosAlta, @w_regCat "Registros Alta";

Salida:
    
   If Exists (Select Top 1 1
              From   #TempErrores)
      Begin
         Select *
         From   #TempErrores
      End

    Drop table #TempErrores;

    Set Xact_Abort        Off
    Return

End
 RegistrosAlta Registros Alta 
 ------------- -------------- 
        952749              0 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> Declare
   @w_tabla                   Sysname,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Smallint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_sql                     Varchar(Max),
   @w_desc_error              Varchar( 250);

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = -1,
          @w_comilla   = Char(39),
          @w_registros = 0;

   Select @w_anio = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.poliza)
         Begin
            Begin Try
               Delete dbo.movimientos
               Delete dbo.poliza
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      While @w_mes < 13
      Begin
         Select @w_mes   = @w_mes + 1,
                @w_chmes = dbo.Fn_BuscaMes (@w_mes),
                @w_tabla = Concat('mov', @w_chmes, @w_anio);

         If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
            Begin
               Goto Siguiente
            End

         Set @w_sql = Concat('Select Referencia, Fecha_mov, Fecha_Cap,       Concepto, ',
                                 'Cargos,     Abonos,    TCons,           Usuario, ',
                                 'TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela, ',
                                 'Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos, ',
                                 @w_anio, ', ', @w_mes, ' 
                    From   Ejercicio_DES.dbo.' + @w_tabla);

         Begin Try
            Insert Into dbo.poliza
            (Referencia, Fecha_mov, Fecha_Cap,       Concepto,
             Cargos,     Abonos,    TCons,           Usuario,
             TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela,
             Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos,
             ejercicio,  mes)
            Execute(@w_sql)
            Set @w_registros = @w_registros + @@Rowcount;
         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If @w_error != 0
            Begin
               Select @w_error, @w_desc_error;
               RollBack Transaction

               Goto Salida
            End

Siguiente:

      End

   Commit Transaction

Salida:

   Select @w_registros "Nuevos Registros";

   Set Xact_Abort    Off
   Return

End
 Nuevos Registros 
 ---------------- 
           210412 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> 165> 166> 167> 168> 169> 170> 171> 172> 173> 174> 175> 176> 177> 178> 179> 180> 181> 182> 183> 184> Declare
   @w_idError                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_desc_error              Varchar( 250),
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_ultactual = Getdate();

   Select @w_anio = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Goto Salida
      End

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Create Table #TempErrores
   (secuencia   Integer Not Null Identity (1, 1) Primary Key,
    Tabla       Sysname,
    comando     Varchar(Max),
    mensaje     Varchar(Max));

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.movimientos)
         Begin
            Begin Try
               Delete dbo.movimientos
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      While @w_mes < 12
      Begin
         Select @w_mes   = @w_mes + 1,
                @w_chmes = dbo.Fn_BuscaMes (@w_mes),
                @w_tabla = Concat('pol', @w_chmes, @w_anio);

         If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
            Begin
               Goto Siguiente
            End

         Set @w_sql = Concat('Select Distinct Referencia,      Cons, ' , @w_comilla, '00', @w_comilla, ' Moneda,      Fecha_mov, ',
                                    'Llave,           Concepto,         Importe,       Documento, ',
                                    'Clave,           FecCap,',         @w_comilla, '00', @w_comilla, ',   Sucursal_id, ',
                                    'Region_id,       Importe_Cargo,    Importe_Abono, Descripcion, ',
                                    'TipoPolizaConta, ReferenciaFiscal, Fecha_Doc, ',
                                    @w_anio, ', ', @w_mes, ' ',
                            'From   Ejercicio_DES.dbo.', @w_tabla, ' a ',
                            'Where  Exists ( Select Top 1 1 ',
                                            'From   dbo.poliza ',
                                            'Where  Referencia = a.Referencia ',
                                            'And    Fecha_mov  = a.Fecha_mov ',
                                            'And    ejercicio  = ', @w_anio, ' ',
                                            'And    mes        = ', @w_mes, ') ',
                            'And    Exists  (Select Top 1 1 ',
                                            'From   dbo.CatalogoConsolidado ',
                                            'Where  numerodecuenta = a.llave ',
                                            'And    Moneda_id      = ', @w_comilla, '00', @w_comilla, ') ');

         Begin Try
            Insert Into dbo.movimientos
           (Referencia,      Cons,             Moneda,        Fecha_mov,
            Llave,           Concepto,         Importe,       Documento,
            Clave,           FecCap,           Sector_id,     Sucursal_id,
            Region_id,       Importe_Cargo,    Importe_Abono, Descripcion,
            TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     Ejercicio,
            mes)
            Execute(@w_sql)
            Set @w_registros = @w_registros + @@Rowcount;
         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If @w_error != 0
            Begin
               Select @w_error, @w_desc_error;

               Rollback Transaction

               Insert Into #TempErrores
              (Tabla, comando, mensaje)
               Select @w_tabla, @w_sql, @w_desc_error

               Select @w_error      = 0,
                      @w_desc_error = '';

               Goto Salida
            End

Siguiente:

      End

   Commit Transaction

   Select @w_registros  "Nuevos Registros";

Salida:

   If Exists ( Select Top 1 1
               From   #TempErrores )
      Begin
         Select *
         From   #TempErrores;
      End

   Drop table #TempErrores;

   Set Xact_Abort  Off
   Return

End
 Nuevos Registros 
 ---------------- 
          1185066 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_mes                     Integer,
   @w_registros               Integer,
   @w_regCat                  Integer,
   @w_linea                   Integer,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_desc_error              Varchar(  Max),
--
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;


Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = -1,
          @w_anioIni   = 2017,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_ultactual = Getdate();

   Select @w_anioFin = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Goto Salida
      End

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.CatalogoCierreTbl)
         Begin
            Begin Try
               truncate table dbo.CatalogoCierreTbl
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End
         End

      While @w_anioIni  < @w_anioFin
      Begin
         Select @w_mes     = 13,
                @w_anioIni = @w_anioIni + 1,
                @w_tabla   = Concat('CatCie', @w_anioIni);

         If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
            Begin
               Goto Siguiente
            End

         Set @w_sql = Concat('Select Distinct Llave, ', @w_comilla, '00', @w_comilla, ' Moneda,   Niv,        Descrip, ',
                                    'SAnt,         Car,        Abo,        SAct, ',
                                    'FecCap,       CarProceso, AboProceso, SAntProceso, ',
                                    'CarExt,       AboExt,     SProm,      SPromAnt, ',
                                    'Nivel_sector, SProm2,     Sprom2Ant, ',
                                     @w_anioIni, ', ', @w_mes, ' ',
                             'From   Ejercicio_DES.dbo.', @w_tabla, ' a ',
                             'Where  Exists     (Select Top 1 1 ',
                                                'From   dbo.CatalogoConsolidado ',
                                                'Where  numerodecuenta = a.llave ',
                                                'And    Moneda_id      = ', @w_comilla, '00', @w_comilla, ' ) ');
         Begin Try
            Insert Into dbo.CatalogoCierreTbl
           (Llave,        Moneda,     Niv,        Descrip,
            SAnt,         Car,        Abo,        SAct,
            FecCap,       CarProceso, AboProceso, SAntProceso,
            CarExt,       AboExt,     SProm,      SPromAnt,
            Nivel_sector, SProm2,     Sprom2Ant,  Ejercicio,
            Mes)
            Execute(@w_sql)
            Set @w_registros = @w_registros + @@Rowcount;
         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If @w_error != 0
            Begin
               Select @w_error, @w_desc_error;

               Rollback Transaction;

               Select @w_error      = 0,
                      @w_desc_error = '';

               Goto Salida
            End

Siguiente:

      End;

   Commit Transaction;

   Select @w_registros RegistrosAlta;

Salida:


   Set Xact_Abort        Off
   Return

End
 RegistrosAlta 
 ------------- 
         47170 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_sql                     Varchar(Max),
   @w_desc_error              Varchar( 250);

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anioIni   = 2017,
          @w_anioFin   = 2024,
          @w_comilla   = Char(39),
          @w_registros = 0;

   Select @w_anioFin = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.PolizaAnio)
         Begin
            Begin Try
               Delete dbo.MovimientosAnio
               Delete dbo.PolizaAnio
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      While @w_anioIni  < @w_anioFin
      Begin
         Select @w_mes     = 0,
                @w_anioIni = @w_anioIni + 1,
                @w_tabla = Concat('movDia', @w_anioIni);

         If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
            Begin
               Goto Siguiente
            End

         Set @w_sql = Concat('Select Distinct Referencia, Fecha_mov, Fecha_Cap,       Concepto, ',
                                    'Cargos,     Abonos,    TCons,           Usuario, ',
                                    'TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela, ',
                                    'Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos, ',
                                     @w_anioIni, ', DatePart(mm, fecha_Mov) ',
                             'From   Ejercicio_DES.dbo.' + @w_tabla);

         Begin Try
            Insert Into dbo.PolizaAnio
            (Referencia, Fecha_mov, Fecha_Cap,       Concepto,
             Cargos,     Abonos,    TCons,           Usuario,
             TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela,
             Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos,
             ejercicio,  mes)
            Execute(@w_sql)
         
            Set @w_registros = @w_registros + @@Rowcount;

         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)
         
         End   Catch
         
         If @w_error != 0
            Begin
               Select @w_error, @w_desc_error;
               RollBack Transaction
         
               Goto Salida
            End

Siguiente:


      End

    Commit Transaction

    Select @w_registros RegistrosAdic;

Salida:


    Set Xact_Abort    On
    Return

End
 RegistrosAdic 
 ------------- 
         61734 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> 165> 166> 167> 168> 169> 170> 171> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Smallint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_desc_error              Varchar( 250),
   @w_inicio                  Bit,
   @w_mesProc                 Tinyint,
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = -1,
          @w_anioIni   = 0,
          @w_anioFin   = 0,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_inicio    = 1;

   Select @w_anioIni  = Datepart(yyyy, parametroFecha) -1,
          @w_mesProc  = Datepart(mm,   parametroFecha)
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 11;
   
   Select @w_anioFin = ejercicio -1
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Goto Salida
      End

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   
   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.PolizaHist)
         Begin
            Begin Try
               Delete dbo.MovimientosHist
               Delete dbo.PolizaHist
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      While @w_anioIni  < @w_anioFin
      Begin
         Select @w_mes     = -1,
                @w_anioIni = @w_anioIni + 1;

         If @w_inicio = 1
            Begin
               Select @w_mes    = @w_mesProc -1,
                      @w_inicio = 0;
            End

         While @w_mes < 13
         Begin
            Select @w_mes   = @w_mes + 1,
                   @w_chmes = dbo.Fn_BuscaMes (@w_mes),
                   @w_tabla = Concat('mov', @w_chmes, @w_anioIni);

            If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
               Begin
                  Goto Siguiente
               End

            Set @w_sql = Concat('Select Referencia, Fecha_mov, Fecha_Cap,       Concepto, ',
                                       'Cargos,     Abonos,    TCons,           Usuario, ',
                                       'TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela, ',
                                       'Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos, ',
                                        @w_anioIni, ', ', @w_mes, ' ',
                                'From   Ejercicio_DES.dbo.' + @w_tabla);

            Begin Try
               Insert Into dbo.PolizaHist
               (Referencia, Fecha_mov, Fecha_Cap,       Concepto,
                Cargos,     Abonos,    TCons,           Usuario,
                TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela,
                Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos,
                ejercicio,  mes)
               Execute(@w_sql)

               Set @w_registros = @w_registros + @@Rowcount;

           End Try

           Begin Catch
              Select  @w_Error      = @@Error,
                      @w_linea      = Error_line(),
                      @w_desc_error = Substring (Error_Message(), 1, 200)

           End   Catch

           If @w_error != 0
              Begin
                 Select @w_error, @w_desc_error;
                 RollBack Transaction

                 Goto Salida
              End

Siguiente:

      End

    End

    Commit Transaction
    Select @w_registros RegistrosAdic;;

Salida:
    Set Xact_Abort    On
    Return

End
 RegistrosAdic 
 ------------- 
        662218 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> 165> 166> 167> 168> 169> 170> 171> 172> 173> 174> 175> 176> 177> 178> 179> 180> 181> 182> 183> 184> 185> 186> 187> 188> 189> 190> 191> 192> 193> 194> 195> 196> 197> 198> 199> 200> 201> 202> 203> 204> 205> 206> 207> 208> 209> Declare
   @w_idError                 Integer,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_regCat                  Integer,
   @w_linea                   Integer,
   @w_mes                     Smallint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_tablaMov                Sysname,
   @w_desc_error              Varchar( 250),
--
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime,
   @w_inicio                  Bit,
   @w_mesProc                 Tinyint;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anioIni   = 0,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_inicio    = 1,
          @w_ultactual = Getdate();;

   Select @w_anioIni  = Datepart(yyyy, parametroFecha) -1,
          @w_mesProc  = Datepart(mm,   parametroFecha)
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 11;
   
   Select @w_anioFin = ejercicio -1
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Goto Salida
      End

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Create Table #TempErrores
   (secuencia   Integer Not Null Identity (1, 1) Primary Key,
    Tabla       Sysname,
    comando     Varchar(Max),
    mensaje     Varchar(Max));

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.movimientosHist)
         Begin
            Begin Try
               Delete dbo.movimientosHist
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End
         End

      While @w_anioIni  < @w_anioFin
      Begin
         Select @w_mes     = -1,
                @w_anioIni = @w_anioIni + 1;

         If @w_inicio = 1
            Begin
               Select @w_mes    = @w_mesProc -1,
                      @w_inicio = 0;
            End

         While @w_mes < 13
         Begin
            Select @w_mes      = @w_mes + 1,
                   @w_chmes    = dbo.Fn_BuscaMes (@w_mes),
                   @w_tabla    = Concat('pol', @w_chmes, @w_anioIni),
                   @w_tablaMov = Concat('mov', @w_chmes, @w_anioIni);

            If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
               Begin
                  Goto Siguiente
               End

            Set @w_sql = Concat('Select Distinct Referencia,      Cons,', @w_comilla, '00', @w_comilla, ' Moneda,      Fecha_mov, ',
                                       'Llave,           Concepto,         Importe,       Documento, ',
                                       'Clave,           FecCap, ', @w_comilla, '00', @w_comilla, ' Sector_id,       Sucursal_id, ',
                                       'Case When Region_id = 202 Then 5555 Else Region_id End Region_id, ',
                                       'Importe_Cargo,    Importe_Abono, Descripcion, TipoPolizaConta, ',
                                       'ReferenciaFiscal, Fecha_Doc, ',
                                       @w_anioIni, ', ', @w_mes, ' ',
                               'From   Ejercicio_DES.dbo.', @w_tabla, ' a ',
                               'Where  Exists (Select Top 1 1 ',
                                              'From   dbo.PolizaHist ',
                                              'Where  Referencia = a.referencia ',
                                              'And    Fecha_mov  = a.Fecha_mov ',
                                              'And    ejercicio  = ', @w_anioIni, ' ',
                                              'And    mes        = ', @w_mes, ') ',
                               'And    Exists (Select Top 1 1 ',
                                              'From   dbo.CatalogoConsolidado ',
                                              'Where  numerodecuenta = a.llave ',
                                              'And    Moneda_id      = ', @w_comilla, '00', @w_comilla, ') ');

            Begin Try
               Insert Into dbo.movimientosHist
               (Referencia,      Cons,             Moneda,        Fecha_mov,
                Llave,           Concepto,         Importe,       Documento,
                Clave,           FecCap,           Sector_id,     Sucursal_id,
                Region_id,       Importe_Cargo,    Importe_Abono, Descripcion,
                TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     Ejercicio,
                mes)
               Execute(@w_sql)
               Set @w_registros = @w_registros + @@Rowcount

            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Insert Into #TempErrores
                 (Tabla, comando, mensaje)
                  Select @w_tabla, @w_sql, @w_desc_error

                  Select @w_error      = 0,
                         @w_desc_error = '';

                  Goto Salida
               End
         End

Siguiente:

      End

   Commit Transaction

   Select @w_registros "Nuevos Registros";

Salida:

   If Exists ( Select Top 1 1
               From   #TempErrores)
      Begin
         Select *
         From   #TempErrores
      End

   Drop Table #TempErrores;

   Set Xact_Abort  Off
   Return

End
 Nuevos Registros 
 ---------------- 
          3641734 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> Declare
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_regCat                  Integer,
   @w_desc_error              Varchar(  Max),
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_ultactual = Getdate(),
          @w_regCat    = 0;

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction

      If Exists ( Select Top 1 1
                  From   dbo.MapeoCodigoAgrupador)
         Begin
            Begin Try
               Truncate Table dbo.MapeoCodigoAgrupador
            End   Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  Rollback Transaction

                  Goto Salida
               End

         End

      Begin Try
         Insert Into dbo.MapeoCodigoAgrupador
        (Llave,             moneda_id, Niv, Descrip,
         CodigoAgrupador,   Descripcion)
        Select Llave,             '00' moneda_id, Niv, Descrip,
               CodigoAgrupador,   Descripcion
        From   DB_GEN_DES.dbo.MapeoCodigoAgrupador a
        Where  Exists (Select Top 1 1
                       From   dbo.CatalogoConsolidado
                       Where  numerodecuenta = a.llave
                       And    Moneda_id      = '00')
        Set @w_registros = @@Rowcount
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error, @w_desc_error;
            Rollback Transaction

            Goto Salida
         End

   Commit Transaction

   Select @w_registros "Registros Nuevos"

Salida:

  Set Xact_Abort Off
  Return

End
 Registros Nuevos 
 ---------------- 
               15 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> Declare
   @w_tabla                   Sysname,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_sql                     Varchar(Max),
   @w_desc_error              Varchar( 250);

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_comilla   = Char(39),
          @w_registros = 0;

   Select @w_anio = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.PolDia)
         Begin
            Begin Try
               Delete dbo.MovDia
               Delete dbo.PolDia
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      Begin Try     
         Insert Into dbo.PolDia
         (Referencia, Fecha_Mov, Fecha_Cap,       Concepto,
          Cargos,     Abonos,    TCons,           Usuario,
          TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela,
          Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos,
          Ejercicio,  Mes,       CausaRechazo)
         Select Referencia, Fecha_Mov, Fecha_Cap,       Concepto,
                Cargos,     Abonos,    TCons,           Usuario,
                TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela,
                Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos,
                DatePart(yyyy, Fecha_Mov) Ejercicio,  DatePart(mm, Fecha_Mov) Mes,
                Causa_Rechazo
         From   DB_Gen_des.dbo.MovDia

            Set @w_registros = @w_registros + @@Rowcount;
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error, @w_desc_error;
            RollBack Transaction

            Goto Salida
         End

   Commit Transaction

Salida:

   Select @w_registros "Nuevos Registros";

   Set Xact_Abort    Off
   Return

End
 Nuevos Registros 
 ---------------- 
             2272 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> Declare
   @w_idError                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_desc_error              Varchar( 250),
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_ultactual = Getdate();

   Select @w_anio = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Goto Salida
      End

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.MovDia)
         Begin
            Begin Try
               truncate table dbo.MovDia
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End
    
      Set @w_tabla = 'poldia';
   
      If DB_Gen_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
         Begin
            Select 9999 Error, Concat('La tabla ', @w_tabla, ' No Existe en la BD Origen,') mensajeError
            Goto Salida
         End

     Set @w_sql = Concat('Select Distinct Referencia,      Cons, ', @w_comilla, '00', @w_comilla, 'Moneda,      Fecha_mov, ',
                                'Llave,           Concepto,         Importe,       Documento, ',
                                'Clave,           FecCap,',         @w_comilla, '00', @w_comilla, ',   Sucursal_id, ',
                                'Region_id,       Importe_Cargo,    Importe_Abono, Descripcion, ',
                                'TipoPolizaConta, ReferenciaFiscal, Fecha_Doc, ',
                                'DatePart(yyyy, Fecha_Mov) Ejercicio,  DatePart(mm, Fecha_Mov) Mes ',
                        'From   DB_Gen_DES.dbo.', @w_tabla, ' a ',
                        'Where  Exists ( Select Top 1 1 ',
                                        'From   dbo.PolDia ',
                                        'Where  Referencia = a.Referencia ',
                                        'And    Fecha_mov  = a.Fecha_mov ',
                                        'And    ejercicio  = DatePart(yyyy, a.Fecha_Mov) ',
                                        'And    mes        = DatePart(mm, a.Fecha_Mov)) ',
                        'And    Exists (Select Top 1 1 ',
                                       'From   dbo.CatalogoConsolidado ',
                                       'Where  numerodecuenta = a.llave ',
                                       'And    Moneda_id      = ', @w_comilla, '00', @w_comilla, ')' );

     Begin Try      
        Insert Into dbo.MovDia
       (Referencia,      Cons,             Moneda,        Fecha_mov,
        Llave,           Concepto,         Importe,       Documento,
        Clave,           FecCap,           Sector_id,     Sucursal_id,
        Region_id,       Importe_Cargo,    Importe_Abono, Descripcion,
        TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     Ejercicio,
        Mes)
        Execute(@w_sql)
        Set @w_registros = @w_registros + @@Rowcount;
     End Try
      
     Begin Catch
        Select  @w_Error      = @@Error,
                @w_linea      = Error_line(),
                @w_desc_error = Substring (Error_Message(), 1, 200)
     
     End   Catch
         
     If @w_error != 0
        Begin
           Select @w_error Error, @w_desc_error mensajeError;
           RollBack Transaction     
     
           Goto Salida
        End

   Commit Transaction

   Select @w_registros RegistrosAlta;

Salida:

   Set Xact_Abort  Off
   Return

End
 RegistrosAlta 
 ------------- 
         12268 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> Declare
   @w_idError                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_desc_error              Varchar( 250),
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anio      = 2024,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_ultactual = Getdate();

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.Promedios)
         Begin
            Begin Try
               Delete dbo.Promedios
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      Set @w_tabla = 'dbo_Promedios';

      If DB_Gen_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
         Begin
            Select 9999 Error, Concat('La tabla ', @w_tabla, ' No Existe en la BD Origen,') mensajeError
            Goto Salida
         End

     Begin Try
        Insert Into dbo.Promedios
        (Llave,   moneda_id, Ejercicio, mes,
         Sact,    Sacu,      Spro,      Sprom2,
         sfinmes, totcar,    totabo,    campo_valor)
        Select numerodecuenta, '00' moneda_mex, Round(periodo / 100, 0) ejercicio, periodo % 100 mes,
               Sact,           Sacu,         Spro,                              Isnull(Sprom2, 0),
               sfinmes,        totcar,       totabo,                            campo_valor
        From   DB_Gen_DES.dbo.dbo_Promedios
        Where  Exists (Select Top 1 1
                       From   dbo.CatalogoConsolidado a
                       Where  numerodecuenta = a.numerodecuenta
                       And    Moneda_id      = '00');

        Set @w_registros = @w_registros + @@Rowcount;
     End Try

     Begin Catch
        Select  @w_Error      = @@Error,
                @w_linea      = Error_line(),
                @w_desc_error = Substring (Error_Message(), 1, 200)

     End   Catch

     If @w_error != 0
        Begin
           Select @w_error Error, @w_desc_error mensajeError;
           RollBack Transaction

           Goto Salida
        End

   Commit Transaction

   Select @w_registros RegistrosAlta;

Salida:

   Set Xact_Abort  Off
   Return

End
 RegistrosAlta 
 ------------- 
        862872 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> Declare
   @w_idError                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_desc_error              Varchar( 250),
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anio      = 2024,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_ultactual = Getdate();

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.AuxiliaresCorporativos)
         Begin
            Begin Try
               truncate table dbo.AuxiliaresCorporativos
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      Set @w_tabla = 'AuxiliaresCorporativos';

      If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
         Begin
            Select 9999 Error, Concat('La tabla ', @w_tabla, ' No Existe en la BD Origen,') mensajeError
            Goto Salida
         End

     Begin Try
        Insert Into dbo.AuxiliaresCorporativos
        (llave, moneda_id, user_id)
        Select llave, '00', @w_usuario
        From Ejercicio_DES.dbo.AuxiliaresCorporativos a
        -- Where  Exists (Select Top 1 1
                       -- From   dbo.CatalogoConsolidado
                       -- Where  numerodecuenta = a.llave
                       -- And    Moneda_id      = 1);

        Set @w_registros = @w_registros + @@Rowcount;
     End Try

     Begin Catch
        Select  @w_Error      = @@Error,
                @w_linea      = Error_line(),
                @w_desc_error = Substring (Error_Message(), 1, 200)

     End   Catch

     If @w_error != 0
        Begin
           Select @w_error Error, @w_desc_error mensajeError;
           RollBack Transaction

           Goto Salida
        End

   Commit Transaction

   Select @w_registros RegistrosAlta;

Salida:

   Set Xact_Abort  Off
   Return

End
 RegistrosAlta 
 ------------- 
            29 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> Declare
   @w_idError                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_desc_error              Varchar( 250),
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anio      = 2024,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_ultactual = Getdate();

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.Cuentas_predeterminadas)
         Begin
            Begin Try
               Delete dbo.Cuentas_predeterminadas
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      Set @w_tabla = 'Cuentas_predeterminadas';

      If DB_GEN_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
         Begin
            Select 9999 Error, Concat('La tabla ', @w_tabla, ' No Existe en la BD Origen,') mensajeError
            Goto Salida
         End

     Begin Try
        Insert Into dbo.Cuentas_predeterminadas
        (Id, Descripcion, CuentaInterna, TipoPoliza, moneda_id)
        Select id, Descripcion, CuentaInterna, Isnull(TipoPoliza, 'PDI') TipoPoliza, '00' moneda_id
        From   DB_GEN_DES.dbo.Cuentas_predeterminadas

        Set @w_registros = @w_registros + @@Rowcount;
     End Try

     Begin Catch
        Select  @w_Error      = @@Error,
                @w_linea      = Error_line(),
                @w_desc_error = Substring (Error_Message(), 1, 200)

     End   Catch

     If @w_error != 0
        Begin
           Select @w_error Error, @w_desc_error mensajeError;
           RollBack Transaction

           Goto Salida
        End

   Commit Transaction

   Select @w_registros RegistrosAlta;

Salida:

   Set Xact_Abort  Off
   Return

End
 RegistrosAlta 
 ------------- 
             2 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> Declare
   @w_idError                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_desc_error              Varchar( 250),
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anio      = 2024,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_ultactual = Getdate();

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.xmlContabilidadElectronica)
         Begin
            Begin Try
               Delete dbo.xmlContabilidadElectronica
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End
    
      Set @w_tabla = 'xmlContabilidadElectronica';
   
      If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
         Begin
            Select 9999 Error, Concat('La tabla ', @w_tabla, ' No Existe en la BD Origen,') mensajeError
            Goto Salida
         End
   
     Begin Try      
        Insert Into dbo.xmlContabilidadElectronica
        (xmlEnvio, textEnvio, tipo, NombreArchivo,
         user_id)
        Select xmlEnvio, textEnvio, tipo, NombreArchivo,
               @w_usuario
        From Ejercicio_DES.dbo.xmlContabilidadElectronica

        Set @w_registros = @w_registros + @@Rowcount;
     End Try
      
     Begin Catch
        Select  @w_Error      = @@Error,
                @w_linea      = Error_line(),
                @w_desc_error = Substring (Error_Message(), 1, 200)
     
     End   Catch
         
     If @w_error != 0
        Begin
           Select @w_error Error, @w_desc_error mensajeError;
           RollBack Transaction     
     
           Goto Salida
        End

   Commit Transaction

   Select @w_registros RegistrosAlta, @w_regCat "Nuevos Registros";

Salida:

   Set Xact_Abort  Off
   Return

End
 RegistrosAlta Nuevos Registros 
 ------------- ---------------- 
             3                0 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> Declare
   @w_idError                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_desc_error              Varchar( 250),
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anio      = 2024,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_ultactual = Getdate();

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.XmlPoliza)
         Begin
            Begin Try
               Delete dbo.XmlPoliza
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End
    
      Set @w_tabla = 'XmlPoliza';
   
      If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
         Begin
            Select 9999 Error, Concat('La tabla ', @w_tabla, ' No Existe en la BD Origen,') mensajeError
            Goto Salida
         End
   
     Begin Try      
        Insert Into dbo.XmlPoliza
        (XmlPoliza, NombreArchivo, user_id)
        Select XmlPoliza, NombreArchivo, @w_usuario
        From Ejercicio_DES.dbo.XmlPoliza

        Set @w_registros = @w_registros + @@Rowcount;
     End Try
      
     Begin Catch
        Select  @w_Error      = @@Error,
                @w_linea      = Error_line(),
                @w_desc_error = Substring (Error_Message(), 1, 200)
     
     End   Catch
         
     If @w_error != 0
        Begin
           Select @w_error Error, @w_desc_error mensajeError;
           RollBack Transaction     
     
           Goto Salida
        End

   Commit Transaction

   Select @w_registros RegistrosAlta;

Salida:

   Set Xact_Abort  Off
   Return

End
 RegistrosAlta 
 ------------- 
             1 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_mes                     Smallint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_sql                     Varchar(Max),
   @w_desc_error              Varchar( 250);

Begin
   Set Nocount       On

   Select @w_mes       = 0,
          @w_anioIni   = 0,
          @w_comilla   = Char(39),
          @w_registros = 0;

   Select @w_anioIni  = Datepart(yyyy, parametroFecha) -1
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 11;

   Select @w_anioFin = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Return
      End

   Select @w_mes   = Max(valor)
   From   catCriteriosTbl
   Where  criterio = 'mes'
   And    idEstatus = 1;

--

   While @w_anioIni  < @w_anioFin
   Begin
      Select @w_anioIni = @w_anioIni + 1,
             @w_tabla = Concat('MovCie', @w_chmes, @w_anioIni);

         If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
            Begin
               Goto Siguiente
            End

         If Exists ( Select Top 1 1
                     From   dbo.PolizaCierre
                     Where  ejercicio = @w_anioIni)
            Begin
               Delete dbo.MovimientosCierre
               Where  ejercicio = @w_anioIni;

               Delete dbo.PolizaCierre
               Where  ejercicio = @w_anioIni;
            End

         Set @w_sql = Concat('Select Referencia, Fecha_mov, Fecha_Cap,       Concepto, ',
                                    'Cargos,     Abonos,    TCons,           Usuario, ',
                                    'TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela, ',
                                    'Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos, ',
                                     @w_anioIni, ', ', @w_mes, ' ',
                             'From   Ejercicio_DES.dbo.' + @w_tabla);

         Insert Into dbo.PolizaCierre
         (Referencia, Fecha_mov, Fecha_Cap,       Concepto,
          Cargos,     Abonos,    TCons,           Usuario,
          TipoPoliza, Documento, Usuario_cancela, Fecha_Cancela,
          Status,     Mes_Mov,   TipoPolizaConta, FuenteDatos,
          ejercicio,  mes)
         Execute(@w_sql)

         Set @w_registros = @w_registros + @@Rowcount;

Siguiente:

    End

    Select @w_registros RegistrosAdic;

    Return

End
 RegistrosAdic 
 ------------- 
            44 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> 165> 166> 167> 168> 169> 170> 171> 172> Declare
   @w_idError                 Integer,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Smallint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_tablaMov                Sysname,
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_desc_error              Varchar(  250),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anioIni   = 0,
          @w_comilla   = Char(39),
          @w_registros = 0;


   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Select @w_anioFin = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Return
      End

   Select @w_anioIni  = Datepart(yyyy, parametroFecha) -1
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 11;

   Select @w_mes   = Max(valor)
   From   catCriteriosTbl
   Where  criterio = 'mes'
   And    idEstatus = 1;



   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.movimientosCierre)
         Begin
            Begin Try
               Delete dbo.movimientosCierre
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      While @w_anioIni  < @w_anioFin
      Begin
         Select @w_anioIni = @w_anioIni + 1,
                @w_tabla = Concat('PolCie', @w_chmes, @w_anioIni);

         If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
            Begin
               Goto Siguiente
            End

         Set @w_sql = Concat('Select Referencia,      Cons, ', @w_comilla, '00', @w_comilla, ' Moneda,      Fecha_mov, ',
                                    'Llave,           Concepto,         Importe,       Documento, ',
                                    'Clave,           FecCap,',         @w_comilla, '00', @w_comilla, ',   Sucursal_id, ',
                                    'Case When Region_id = 202 Then 5555 Else Region_id End Region_id, ',
                                    'Importe_Cargo,    Importe_Abono, Descripcion, TipoPolizaConta, ',
                                    'ReferenciaFiscal, Fecha_Doc, ',
                                     @w_anioIni, ', ', @w_mes, ' ',
                             'From   Ejercicio_DES.dbo.', @w_tabla, ' a ',
                             'Where  Exists (Select Top 1 1 ',
                                            'From   dbo.PolizaCierre ',
                                            'Where  Referencia = a.referencia ',
                                            'And    Fecha_mov  = a.Fecha_mov ',
                                            'And    ejercicio  = ', @w_anioIni, ' ',
                                            'And    mes        = ', @w_mes, ')');

         Begin Try
            Insert Into dbo.movimientosCierre
            (Referencia,      Cons,             Moneda,        Fecha_mov,
             Llave,           Concepto,         Importe,       Documento,
             Clave,           FecCap,           Sector_id,     Sucursal_id,
             Region_id,       Importe_Cargo,    Importe_Abono, Descripcion,
             TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     Ejercicio,
             mes)
            Execute(@w_sql)
            Set @w_registros = @w_registros + @@Rowcount

         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If @w_error != 0
            Begin
               Select @w_error Error, @w_desc_error mensajeError;
               RollBack Transaction

               Goto Salida
            End

Siguiente:

   End;

   Commit Transaction

   Select @w_registros registros;


Salida:

   Set Xact_Abort  Off
   Return

End
 registros   
 ----------- 
        4858 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_usuario                 Nvarchar(20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_desc_error              Varchar( 250),
   @w_idusuario               Varchar( Max);

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anioIni   = 0,
          @w_comilla   = Char(39),
          @w_registros = 0;

   Select @w_anio = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Return
      End

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;


   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Select @w_anioIni  = Datepart(yyyy, parametroFecha) -1
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 11;

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.ControlCierreTbl)
         Begin
            Begin Try
               Delete dbo.ControlCierreTbl
            End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If @w_error != 0
            Begin
               Rollback Transaction
               Select @w_error, @w_desc_error;

               Goto Salida
            End

            End

      While @w_anioIni < @w_anio
      Begin
         Select @w_anioIni = @w_anioIni + 1,
                @w_tabla   = Concat('ControlCierre', @w_anioIni);

         If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
            Begin
               Goto Siguiente
            End


         Set @w_sql = Concat('Select ', @w_anioIni, ', b.valor, ', @w_comilla, Getdate(), @w_comilla, ', Bloqueado, ',
                                        @w_comilla, @w_usuario, @w_comilla, ' ',
                             'From   Ejercicio_DES.dbo.' + @w_tabla, ' a ',
                             'Join   dbo.catCriteriosTbl b ',
                             'On     b.descripcion = a.mes ',
                             'Where  b.criterio    = ', @w_comilla, 'mes', @w_comilla);

         Begin Try
            Insert Into dbo.ControlCierreTbl
           (Ejercicio, Mes, FechaProceso, Bloqueado, NomUser)
            Execute(@w_sql)
            Set @w_registros = @w_registros + @@Rowcount;
         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If @w_error != 0
            Begin
               Rollback Transaction
               Select @w_error, @w_desc_error;

               Goto Salida
            End

Siguiente:

       End

   Commit Transaction

   Select @w_registros;

Salida:

   Set Xact_Abort Off

   Return

End
             
 ----------- 
          14 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Smallint,
   @w_anioProc                Smallint,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_mesProc                 Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_usuario                 Nvarchar(20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_desc_error              Varchar( 250),
   @w_idusuario               Varchar( Max);

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anioIni   = 0,
          @w_comilla   = Char(39),
          @w_registros = 0;

   Select @w_anio = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Return
      End

   Select @w_anioIni  = Datepart(yyyy, parametroFecha) -1,
          @w_anioProc = Datepart(yyyy, parametroFecha),
          @w_mesProc  = Datepart(mm,   parametroFecha)
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 11;

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.ControlPoliza)
         Begin
            Delete dbo.ControlPoliza
         End

      While @w_anioIni < @w_anio
      Begin
         Select @w_anioIni = @w_anioIni + 1,
                @w_tabla   = Concat('ContPol', @w_anioIni);

         If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
            Begin
               Goto Siguiente
            End


         Set @w_sql = Concat('Select a.tipo, ', @w_anioIni, ', b.valor, Contador ',
                             'From   Ejercicio_DES.dbo.' + @w_tabla, ' a ',
                             'Join   dbo.catCriteriosTbl b ',
                             'On     b.ValorAdicional = a.mes ',
                             'Where  b.criterio       = ', @w_comilla, 'mes', @w_comilla);

         Begin Try
            Insert Into dbo.ControlPoliza
            (TipoComprobante, Ejercicio, Mes, Contador)
            Execute(@w_sql)
            Set @w_registros = @w_registros + @@Rowcount;
         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If @w_error != 0
            Begin
               Select @w_error Error, @w_desc_error mensajeError;
               RollBack Transaction

               Goto Salida
            End

Siguiente:

      End

      Begin Try
         Delete dbo.ControlPoliza
         Where  Ejercicio = @w_anioProc
         And    Mes       < @w_mesProc;
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error Error, @w_desc_error mensajeError;
            RollBack Transaction

            Goto Salida
         End

   Commit Transaction

   Select @w_registros;

Salida:

   Set Xact_Abort    Off
   Return

End
             
 ----------- 
         168 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_desc_error              Varchar(  250),
   @w_idusuario               Varchar(  Max),
   @w_fechaAct                Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anioIni   = 2016,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_fechaAct  = Getdate();

   Select @w_anio = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Return
      End

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.PolDiaError)
         Begin
            truncate table dbo.MovDiaError
            Delete dbo.PolDiaError
         End

      Begin Try
         Insert Into dbo.PolDiaError
        (Referencia,  Fecha_Mov,      Fecha_Cap,       Concepto,
         Cargos,      Abonos,         TCons,           Usuario,
         TipoPoliza,  Documento,      Usuario_cancela, Fecha_Cancela,
         Status,      Mes_Mov,        TipoPolizaConta, FuenteDatos,
         Ejercicio,   mes,            Causa_Rechazo,
         Fecha_importacion)
         Select Referencia, Fecha_Mov,     Fecha_Cap,       Concepto,
                Cargos,     Abonos,        TCons,           Usuario,
                TipoPoliza, Documento,     Usuario_cancela, Fecha_Cancela,
                Status,     Mes_Mov,       TipoPolizaConta, FuenteDatos,
                Datepart(yyyy, Fecha_Mov)  Ejercicio, Datepart(mm, Fecha_Mov)  mes,
                Causa_Rechazo, Fecha_importacion
         From   DB_GEN_DES.dbo.MovDiaError
         Where  Referencia Is Not Null
         And    Datepart(yyyy, Fecha_Mov) = @w_anio
         Set @w_registros = @w_registros + @@Rowcount;
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error Error, @w_desc_error mensajeError;
            RollBack Transaction

            Goto Salida
         End

   Commit Transaction

   Select @w_registros;

Salida:

   Set Xact_Abort    Off
   Return

End
             
 ----------- 
     1416299 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_desc_error              Varchar(  250),
   @w_idusuario               Varchar(  Max),
   @w_fechaAct                Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anioIni   = 2016,
          @w_anio      = 2024,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_fechaAct  = Getdate();

   Select @w_anio = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Return
      End
   
   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.MovDiaError)
         Begin
            truncate table dbo.MovDiaError
         End

      Begin Try
         Insert Into dbo.MovDiaError
        (Referencia,      Cons,             Moneda,        Fecha_mov,
         Llave,           Concepto,         Importe,       Documento,
         Clave,           FecCap,           Sector_id,     Sucursal_id,
         Region_id,       Importe_Cargo,    Importe_Abono, Descripcion,
         TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     Ejercicio,
         Mes,             Causa_Rechazo,    Fecha_importacion)
         Select Distinct a.Referencia,      a.Cons,             '00' Moneda_id,            a.Fecha_mov,
                a.Llave,           a.Concepto,         Isnull(a.Importe, 0),   a.Documento,
                a.Clave,           a.FecCap,           a.Sector_id,            a.Sucursal_id,
                a.Region_id,       Isnull(a.Importe_Cargo, 0),    Isnull(a.Importe_Abono, 0), a.Descripcion,
                a.TipoPolizaConta, a.ReferenciaFiscal, a.Fecha_Doc,            Datepart(yyyy, fecha_mov) Ejercicio,
                Datepart(mm, fecha_mov) Mes,           a.Causa_Rechazo,        a.Fecha_importacion
         From   DB_GEN_DES.dbo.PolDiaError a
         Where   Datepart(yyyy, fecha_mov) = @w_anio
         Set @w_registros = @w_registros + @@Rowcount;
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error Error, @w_desc_error mensajeError;
            RollBack Transaction

            Goto Salida
         End

   Commit Transaction

   Select @w_registros;

Salida:

   Set Xact_Abort    Off
   Return

End
             
 ----------- 
     6876886 

1> 2> 3> 4> 


1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anio                    Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_desc_error              Varchar(  250),
   @w_idusuario               Varchar(  Max),
   @w_fechaAct                Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anioIni   = 2016,
          @w_anio      = 2024,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_fechaAct  = Getdate();

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.CatalogoAuxiliarCierreTbl)
         Begin
            truncate table dbo.CatalogoAuxiliarCierreTbl
         End

      Begin Try
         Insert Into dbo.CatalogoAuxiliarCierreTbl
        (Llave,     Moneda,     Niv,        Sector_id,   Sucursal_id,
         Region_id, Descrip,    SAnt,       Car,         Abo,
         SAct,      FecCap,     CarProceso, AboProceso,  SAntProceso,
         CarExt,    AboExt,     SProm,      SPromAnt,    SProm2,
         SProm2Ant, ejercicio,  mes)
         Select Llave,     '00' moneda, Niv,        Sector_id,  Sucursal_id,
                Case When Region_id = 202 Then 5555 Else Region_id End Region_id,
                Descrip,   SAnt,     Car,        Abo,
                SAct,      FecCap,   CarProceso, AboProceso, SAntProceso,
                CarExt,    AboExt,   SProm,      SPromAnt,   SProm2,
                SProm2Ant, DatePart(yyyy, FecCap), DatePart(mm, FecCap)
         From   EJERCICIO_DES.dbo.CatAuxCierre a
         Where  Exists (Select Top 1 1
                        From   dbo.Catalogo
                        Where  llave          = a.Llave
                        And    moneda         = '00'
                        And    ejercicio      = DatePart(yyyy, a.FecCap)
                        And    mes            = DatePart(mm,   a.FecCap))
         Set @w_registros = @w_registros + @@Rowcount;
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error Error, @w_desc_error mensajeError;
            RollBack Transaction

            Goto Salida
         End

   Commit Transaction

   Select @w_registros;

Salida:

   Set Xact_Abort    Off
   Return

End
             
 ----------- 
       14195 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> 165> 166> Declare
   @w_idError                 Integer,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_tablaMov                Sysname,
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_desc_error              Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 0,
          @w_anioIni   = 0,
          @w_comilla   = Char(39),
          @w_registros = 0;


   Select @w_anioFin = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Return
      End

   Select @w_anioIni  = Datepart(yyyy, parametroFecha) -1
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 11;

   Select @w_mes   = Max(valor)
   From   catCriteriosTbl
   Where  criterio = 'mes'
   And    idEstatus = 1;

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.CatalogoAuxiliarCierre)
         Begin
            Begin Try
               truncate table dbo.CatalogoAuxiliarCierre
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      While @w_anioIni  < @w_anioFin
      Begin
         Select @w_anioIni = @w_anioIni + 1,
                @w_tabla = Concat('CatAuxCie', @w_chmes, @w_anioIni);

         If Ejercicio_DES.dbo.Fn_existe_tabla(@w_tabla ) = 0
            Begin
               Goto Siguiente
            End

         Set @w_sql = Concat('Select Distinct Llave, ', @w_comilla, '00', @w_comilla, ', Niv, Sector_id, Sucursal_id, ',
                                    'Case When Region_id = 202 Then 5555 Else Region_id End Region_id, ',
                                    'Descrip, SAnt,    Car,        Abo, ',
                                    'SAct,    FecCap,  CarProceso, AboProceso, SAntProceso, ',
                                    'CarExt,  AboExt,  SProm,      SPromAnt,   SProm2, ',
                                    'SProm2Ant, ', @w_anioIni, ', ', @w_mes, ' ',
                             'From   Ejercicio_DES.dbo.', @w_tabla, ' a ',
                             'Where  Exists (Select Top 1 1 ',
                                            'From   dbo.CatalogoConsolidado ',
                                            'Where  numerodecuenta = a.llave ',
                                            'And    Moneda_id      = ', @w_comilla, '00', @w_comilla, ') ');

         Begin Try
            Insert Into dbo.CatalogoAuxiliarCierre
           (Llave,     Moneda,     Niv,        Sector_id,   Sucursal_id,
            Region_id, Descrip,    SAnt,       Car,         Abo,
            SAct,      FecCap,     CarProceso, AboProceso,  SAntProceso,
            CarExt,    AboExt,     SProm,      SPromAnt,    SProm2,
            SProm2Ant, ejercicio,  mes)
            Execute(@w_sql)
            Set @w_registros = @w_registros + @@Rowcount

         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If @w_error != 0
            Begin
               Select @w_error Error, @w_desc_error mensajeError;
               RollBack Transaction

               Goto Salida
            End

Siguiente:

   End;

   Commit Transaction

   Select @w_registros registros;


Salida:

   Set Xact_Abort  Off
   Return

End
 registros   
 ----------- 
      229394 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> Declare
   @w_idError                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_desc_error              Varchar(  Max);

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_registros = 0;

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.relacion_cuenta_centro_costos)
         Begin
            Begin Try
               Truncate Table dbo.relacion_cuenta_centro_costos
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      Begin Try
         Insert Into dbo.relacion_cuenta_centro_costos
        (cuenta, moneda_id, centro_costos)
         Select cuenta, '00' moneda_id, centro_costos
         From   DB_GEN_DES.dbo.relacion_cuenta_centro_costos;
         Set @w_registros = @w_registros + @@Rowcount

      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error Error, @w_desc_error mensajeError;
            RollBack Transaction

            Goto Salida
         End

   Commit Transaction

   Select @w_registros registros;


Salida:

   Set Xact_Abort  Off
   Return

End
 registros   
 ----------- 
          96 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> Declare
   @w_idError                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_anio                    Integer,
   @w_desc_error              Varchar(  Max);

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_registros = 0,
          @w_linea     = 0;

   Select @w_anio = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Return
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.RelacionImp)
         Begin
            Begin Try
               Truncate Table dbo.RelacionImp
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      Begin Try
         Insert Into dbo.RelacionImp
        (Referencia, Fecha_Mov,   Fecha_Cap,        NewReferencia,
         Usuario,    FuenteDatos, FechaImportacion, Ejercicio,
         mes)
         Select Referencia, Fecha_Mov,   Fecha_Cap,   NewReferencia,
                Usuario,    FuenteDatos, Isnull(FechaImportacion, Fecha_Mov), DatePart(yyyy, Fecha_Mov) ejercicio,
                DatePart(mm, Fecha_Mov) mes
         From   DB_GEN_DES.dbo.RelacionImp;
         Set @w_registros = @w_registros + @@Rowcount

      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error Error, @w_desc_error mensajeError;
            RollBack Transaction

            Goto Salida
         End


   Commit Transaction

   Select @w_registros registros;


Salida:

   Set Xact_Abort  Off
   Return

End
 registros   
 ----------- 
      990273 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> Declare
   @w_idError                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_desc_error              Varchar(  Max);

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_registros = 0;

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.BalanzaComprobacionTbl)
         Begin
            Begin Try
               Truncate Table dbo.BalanzaComprobacionTbl
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      Begin Try
         Insert Into dbo.BalanzaComprobacionTbl
        (llave,       moneda_id, Descrip, region_id,
         sucursal_id, saldo_ant, cargos,  abonos,
         saldo_actual)
         Select llave,    '00' Moneda_id, Descrip, region,
                sucursal, saldo_ant,   cargos,  abonos,
                saldo_actual
         From   Ejercicio_DES.dbo.BalanzaCmpb;
         Set @w_registros = @w_registros + @@Rowcount

      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If @w_error != 0
         Begin
            Select @w_error Error, @w_desc_error mensajeError;
            RollBack Transaction

            Goto Salida
         End

   Commit Transaction

   Select @w_registros registros;


Salida:

   Set Xact_Abort  Off
   Return

End
 registros   
 ----------- 
        5227 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> Declare
   @w_idError                 Integer,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_registros               Integer,
   @w_linea                   Integer,
   @w_mes                     Tinyint,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_tabla                   Sysname,
   @w_tablaMov                Sysname,
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_desc_error              Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = 13,
          @w_anioIni   = 2017,
          @w_comilla   = Char(39),
          @w_registros = 0;

   Select @w_anioFin = ejercicio
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Return
      End

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.movimientosAnio)
         Begin
            Begin Try
               truncate table dbo.movimientosAnio
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      While @w_anioIni  < @w_anioFin
      Begin
         Select @w_anioIni = @w_anioIni + 1,
                @w_tabla = Concat('PolDia', @w_chmes, @w_anioIni);

         If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
            Begin
               Goto Siguiente
            End

         Set @w_sql = Concat('Select Referencia,      Cons, ', @w_comilla, '00', @w_comilla, ' Moneda,      Fecha_mov, ',
                                    'Llave,           Concepto,         Importe,       Documento, ',
                                    'Clave,           FecCap,',         @w_comilla, '00', @w_comilla, ',   Sucursal_id, ',
                                    'Case When Region_id = 202 Then 5555 Else Region_id End Region_id, ',
                                    'Importe_Cargo,    Importe_Abono, Descripcion, TipoPolizaConta, ',
                                    'ReferenciaFiscal, Fecha_Doc, ',
                                     @w_anioIni, ', DatePart(mm, fecha_Mov) ',
                             'From   Ejercicio_DES.dbo.', @w_tabla, ' a ',
                             'Where  Exists (Select Top 1 1 ',
                                            'From   dbo.PolizaAnio ',
                                            'Where  Referencia = a.referencia ',
                                            'And    Fecha_mov  = a.Fecha_mov ',
                                            'And    ejercicio  = ', @w_anioIni, ' ',
                                            'And    mes        = DatePart(mm, a.fecha_Mov)) ',
                             'And    Exists (Select Top 1 1 ',
                                            'From   dbo.CatalogoConsolidado ',
                                            'Where  numerodecuenta = a.llave ',
                                            'And    Moneda_id      = ', @w_comilla, '00', @w_comilla, ') ');

         Begin Try
            Insert Into dbo.movimientosAnio
            (Referencia,      Cons,             Moneda,        Fecha_mov,
             Llave,           Concepto,         Importe,       Documento,
             Clave,           FecCap,           Sector_id,     Sucursal_id,
             Region_id,       Importe_Cargo,    Importe_Abono, Descripcion,
             TipoPolizaConta, ReferenciaFiscal, Fecha_Doc,     Ejercicio,
             mes)
            Execute(@w_sql)
            Set @w_registros = @w_registros + @@Rowcount

         End Try

         Begin Catch
            Select  @w_Error      = @@Error,
                    @w_linea      = Error_line(),
                    @w_desc_error = Substring (Error_Message(), 1, 200)

         End   Catch

         If @w_error != 0
            Begin
               Select @w_error Error, @w_desc_error mensajeError;
               RollBack Transaction

               Goto Salida
            End

Siguiente:

   End;

   Commit Transaction

   Select @w_registros registros;


Salida:

   Set Xact_Abort  Off
   Return

End
 registros   
 ----------- 
      328821 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> 116> 117> 118> 119> 120> 121> 122> 123> 124> 125> 126> 127> 128> 129> 130> 131> 132> 133> 134> 135> 136> 137> 138> 139> 140> 141> 142> 143> 144> 145> 146> 147> 148> 149> 150> 151> 152> 153> 154> 155> 156> 157> 158> 159> 160> 161> 162> 163> 164> 165> 166> 167> 168> 169> 170> 171> 172> 173> 174> 175> 176> 177> 178> 179> 180> 181> 182> 183> 184> 185> 186> 187> 188> 189> 190> 191> 192> 193> 194> 195> 196> 197> 198> 199> 200> 201> 202> 203> 204> 205> 206> 207> 208> Declare
   @w_tabla                   Sysname,
   @w_anioIni                 Integer,
   @w_anioFin                 Integer,
   @w_error                   Integer,
   @w_mes                     Integer,
   @w_mesProc                 Tinyint,
   @w_mesMax                  Tinyint,
   @w_registros               Integer,
   @w_comilla                 Char(1),
   @w_chmes                   Char(3),
   @w_desc_error              Varchar(Max),
--
   @w_linea                   Integer,
   @w_regCat                  Integer,
   @w_idusuario               Varchar(  Max),
   @w_usuario                 Nvarchar(  20),
   @w_sql                     NVarchar(1500),
   @w_param                   NVarchar( 750),
   @w_ultactual               Datetime,
   @w_inicio                  Bit;

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_mes       = -1,
          @w_anioIni   = 0,
          @w_comilla   = Char(39),
          @w_registros = 0,
          @w_regCat    = 0,
          @w_inicio    = 1,
          @w_ultactual = Getdate();

   Select @w_anioIni  = Datepart(yyyy, parametroFecha) -1,
          @w_mesProc  = Datepart(mm,   parametroFecha)
   From   dbo.conParametrosGralesTbl With (Nolock)
   Where  idParametroGral = 11;

   Select @w_mesMax    = Max(valor)
   From   catCriteriosTbl
   Where  criterio = 'mes'
   And    idEstatus = 1;

   Select @w_anioFin = ejercicio -1
   From   dbo.Control With  (Nolock)
   Where  idEstatus = 1
   If @@Rowcount = 0
      Begin
         Select  @w_Error      = 9999,
                 @w_desc_error = 'Error: No hay Ejercicios en Estatus 1 en la tabla control.'

         Set Xact_Abort Off
         Return
      End

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Create Table #TempErrores
   (secuencia   Integer Not Null Identity (1, 1) Primary Key,
    Tabla       Sysname,
    comando     Varchar(Max),
    mensaje     Varchar(Max));

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.CatalogoAuxiliarHist)
         Begin
            Begin Try
               Delete dbo.CatalogoAuxiliarHist
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error, @w_desc_error;
                  RollBack Transaction

                  Goto Salida
               End

         End

      While @w_anioIni  < @w_anioFin
      Begin
         Select @w_mes     = -1,
                @w_anioIni = @w_anioIni + 1;

             If @w_inicio = 1
                Begin
                   Select @w_mes     = @w_mesProc -1,
                          @w_inicio  = 0;
                End

         While @w_mes < @w_mesMax
         Begin
            Select @w_mes   = @w_mes + 1,
                   @w_chmes = dbo.Fn_BuscaMes (@w_mes),
                   @w_tabla = Case When @w_mes = 0
                                   Then Concat('CatAuxIni', @w_anioIni)
                                   When @w_mes = 13
                                   Then Concat('CatAuxFin', @w_anioIni)
                                   Else Concat('CatAux', @w_chmes, @w_anioIni)
                              End;

            If Ejercicio_DES.dbo.Fn_existe_tabla( @w_tabla ) = 0
               Begin
                  Goto Siguiente
               End

            Set @w_sql = Concat('Select Llave, ', @w_comilla, '00', @w_comilla, ' Moneda,   Niv,          Sector_id, ',
                                       'Sucursal_id, ',
                                       'Case When Region_id = 202 Then 5555 Else Region_id End Region_id, ',
                                       'Descrip,     SAnt, ',
                                       'Car,         Abo,        SAct,        FecCap, ',
                                       'CarProceso,  AboProceso, SAntProceso, CarExt, ',
                                       'AboExt,      SProm,      SPromAnt,    SProm2, ',
                                       'SProm2Ant, ', @w_anioIni, ', ', @w_mes, ' ',
                               'From   Ejercicio_DES.dbo.', @w_tabla, ' a ',
                               'Where  Exists     (Select Top 1 1 ',
                                                   'From   dbo.CatalogoConsolidado ',
                                                   'Where  numerodecuenta = a.Llave ',
                                                   'And    moneda_id      = ', @w_comilla, '00', @w_comilla, ')');

            Begin Try
               Insert Into dbo.CatalogoAuxiliarHist
              (Llave,       Moneda,     Niv,         Sector_id,
               Sucursal_id, Region_id,  Descrip,     SAnt,
               Car,         Abo,        SAct,        FecCap,
               CarProceso,  AboProceso, SAntProceso, CarExt,
               AboExt,      SProm,      SPromAnt,    SProm2,
               SProm2Ant,   ejercicio,  mes)
               Execute(@w_sql)
               Set @w_registros = @w_registros + @@Rowcount;
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_desc_error = Error_Message()
            End   Catch

            If @w_error != 0
               Begin
                  Insert Into #TempErrores
                 (Tabla, comando, mensaje)
                 Select @w_tabla, @w_sql, @w_desc_error

                 Select @w_error      = 0,
                        @w_desc_error = '';

                 Goto Siguiente
               End
         End

Siguiente:

      End

   Commit Transaction

    Select @w_registros "Registros Alta";

Salida:

   If Exists (Select Top 1 1
              From   #TempErrores)
      Begin
         Select *
         From   #TempErrores
      End


    Drop table #TempErrores;

    Set Xact_Abort        Off
    Return

End
 Registros Alta 
 -------------- 
        1820475 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> --
-- Objetivo:    Script de Migración de datos de la Tabla controlImpPolTbl
-- Programador: Pedro Zambrano
-- Fecha:       01/10/2024
--

Declare
   @w_Error                   Integer,
   @w_desc_error              Varchar(Max),
--
   @w_linea                   Integer,
   @w_registros               Integer;


Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_Error     = 0,
          @w_registros = 0,
          @w_linea     = 0;

   Set Identity_insert dbo.controlImpPolTbl On;

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.controlImpPolTbl)
         Begin
            Begin Try
               Delete dbo.controlImpPolTbl
            End Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If @w_error != 0
               Begin
                  Select @w_error error, @w_desc_error "Mensaje Error";
                  RollBack Transaction

                  Goto Salida
               End

         End


      Begin Try
         Insert Into dbo.controlImpPolTbl
        (Id_control, Fecha_Mov, Polizas_Imp, polizas_no_imp)
		 Select Id_control, Fecha_Mov, Polizas_Imp, polizas_no_imp
		 From   DB_GEN_DES.dbo.tmpControl
		 Where  Fecha_Mov Is Not Null;
         Set @w_registros =  @@Rowcount;
      End Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_desc_error = Error_Message()
      End   Catch

      If @w_error != 0
         Begin
            Rollback Transaction
            Select @w_error error, @w_desc_error "Mensaje Error"

         End

   Commit Transaction

   Set Identity_insert dbo.controlImpPolTbl Off;

   Select @w_registros  "Registros Alta";

Salida:

    Set Xact_Abort        Off
    Return

End
 Registros Alta 
 -------------- 
           4235 

1> 1> 2> 3> 4> 5> 6> 7> 8> 9> 10> 11> 12> 13> 14> 15> 16> 17> 18> 19> 20> 21> 22> 23> 24> 25> 26> 27> 28> 29> 30> 31> 32> 33> 34> 35> 36> 37> 38> 39> 40> 41> 42> 43> 44> 45> 46> 47> 48> 49> 50> 51> 52> 53> 54> 55> 56> 57> 58> 59> 60> 61> 62> 63> 64> 65> 66> 67> 68> 69> 70> 71> 72> 73> 74> 75> 76> 77> 78> 79> 80> 81> 82> 83> 84> 85> 86> 87> 88> 89> 90> 91> 92> 93> 94> 95> 96> 97> 98> 99> 100> 101> 102> 103> 104> 105> 106> 107> 108> 109> 110> 111> 112> 113> 114> 115> --
-- Objetivo:    Script de Migración de datos de la Tabla Relacion_Poliza_Interna_Externa
-- Programador: Pedro Zambrano
-- Fecha:       01/10/2024
--

Declare
   @w_Error               Integer,
   @w_linea               Integer,
   @w_registros           Integer,
   @w_comilla             Char(1),
   @w_fechaProc           Datetime,
   @w_Desc_Error          Varchar(  250),
   @w_idusuario           Varchar(  Max),
   @w_usuario             Nvarchar(  20),
   @w_sql                 NVarchar(1500),
   @w_param               NVarchar( 750);

Begin
   Set Nocount       On
   Set Xact_Abort    On

   Select @w_comilla   = Char(39),
          @w_fechaProc = Getdate();

   Select @w_idusuario = parametroChar
   From   dbo.conParametrosGralesTbl
   Where  idParametroGral = 6;

   Select @w_sql   = Concat('Select @o_usuario = dbo.Fn_Desencripta_cadena (', @w_idusuario, ')'),
          @w_param = '@o_usuario    Nvarchar(20) Output';

   Begin Try
      Execute Sp_executeSql @w_sql, @w_param, @o_usuario = @w_usuario Output
   End Try

   Begin Catch
      Select  @w_Error      = @@Error,
              @w_linea      = Error_line(),
              @w_desc_error = Substring (Error_Message(), 1, 200)

   End   Catch

   If @w_error != 0
      Begin
         Select @w_error, @w_desc_error;

         Goto Salida
      End

   Begin Transaction
      If Exists ( Select Top 1 1
                  From   dbo.Relacion_Poliza_Interna_Externa With (Nolock))
         Begin
            Begin Try
               Truncate Table dbo.Relacion_Poliza_Interna_Externa
            End   Try

            Begin Catch
               Select  @w_Error      = @@Error,
                       @w_linea      = Error_line(),
                       @w_desc_error = Substring (Error_Message(), 1, 200)

            End   Catch

            If Isnull(@w_error, 0) != 0
               Begin
                  Rollback Transaction

                  Select @w_error, @w_desc_error;

                  Set Xact_Abort    Off
                  Return
               End

         End

      Begin Try
         Insert Into dbo.Relacion_Poliza_Interna_Externa
        (Referencia, Fecha_Mov, Fuentedatos, Referencia_contable,
         Fecha_Cap,  Usuario)
         Select Referencia, Fecha_Mov, Fuentedatos, Referencia_contable,
                Isnull(Fecha_Cap, @w_fechaProc), Isnull(Usuario, @w_usuario)
         From   DB_GEN_DES.dbo.dbo_Relacion_Poliza_Interna_Externa
         Set @w_registros = @@Rowcount

      End   Try

      Begin Catch
         Select  @w_Error      = @@Error,
                 @w_linea      = Error_line(),
                 @w_desc_error = Substring (Error_Message(), 1, 200)

      End   Catch

      If Isnull(@w_error, 0) != 0
         Begin
            Rollback Transaction

            Select @w_error, @w_desc_error;

            Set Xact_Abort    Off
            Return
         End

   Commit Transaction

   Select @w_registros "Nuevos Registros"

Salida:

   Set Xact_Abort    Off
   Return
End
 Nuevos Registros 
 ---------------- 
           821319 

1> 